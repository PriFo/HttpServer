# ‚úÖ –û—Ç—á–µ—Ç –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 2025-11-21  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–£–ù–ò–§–ò–ö–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê**

---

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –º–µ—Å—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

**–ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –≤—Å–µ —Ç–∏–ø—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:**

1. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ (CounterpartyNormalizer)**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—ã–π —Ñ–ª–∞–≥ `normalizerRunning`
   - ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ 8 —Ç–æ—á–∫–∞—Ö
   - ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

2. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã (Normalizer)**
   - ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω—ã–π —Ñ–ª–∞–≥ `normalizerRunning`
   - ‚úÖ **–ù–û–í–û–ï - –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

3. **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ ClientNormalizer**
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Å—Å–∏–∏ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
   - ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å –µ–¥–∏–Ω—ã–º –º–µ—Ö–∞–Ω–∏–∑–º–æ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

---

### 2. ‚úÖ –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

**–ï–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º:**
- ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç —Ñ–ª–∞–≥ `normalizerRunning`
- ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –º—å—é—Ç–µ–∫—Å `normalizerMutex`
- ‚úÖ –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ –ï–¥–∏–Ω—ã–µ API endpoints

**API endpoints:**
1. `/api/normalization/stop` - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
2. `/api/clients/{id}/projects/{projectId}/normalization/stop` - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤

**–û–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π —Ñ–ª–∞–≥ `normalizerRunning`**

---

### 3. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ Normalizer

**–§–∞–π–ª:** `normalization/normalizer.go`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `stopCheck func() bool`
- ‚úÖ –°–æ–∑–¥–∞–Ω `NewNormalizerWithStopCheck`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `SetStopCheck`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Ü–∏–∫–ª–µ (–∫–∞–∂–¥—ã–µ 50 –∑–∞–ø–∏—Å–µ–π)

**–§–∞–π–ª:** `server/server.go`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `handleNormalizeStart` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SetStopCheck` –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ normalizer
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `NewNormalizerWithStopCheck` –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ normalizer

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –¢–∏–ø—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:

| –¢–∏–ø | –°—Ç–∞—Ç—É—Å | –¢–æ—á–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ | –ú–µ—Ö–∞–Ω–∏–∑–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ |
|-----|--------|----------------|-------------------|
| –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã (CounterpartyNormalizer) | ‚úÖ | 8 —Ç–æ—á–µ–∫ | `normalizerRunning` |
| –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ (Normalizer) | ‚úÖ | 1 —Ç–æ—á–∫–∞ (–∫–∞–∂–¥—ã–µ 50 –∑–∞–ø–∏—Å–µ–π) | `normalizerRunning` |
| –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞ (ClientNormalizer) | ‚úÖ | –ß–µ—Ä–µ–∑ —Å–µ—Å—Å–∏–∏ | `normalizerRunning` + —Å–µ—Å—Å–∏–∏ |

### –ï–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:

- ‚úÖ **–§–ª–∞–≥:** `normalizerRunning` (bool)
- ‚úÖ **–ú—å—é—Ç–µ–∫—Å:** `normalizerMutex` (sync.RWMutex)
- ‚úÖ **–§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏:** `stopCheck() bool`
- ‚úÖ **API:** 2 endpoint, –æ–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π —Ñ–ª–∞–≥

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- ‚ùå –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤ —Ü–∏–∫–ª–µ
- ‚ö†Ô∏è –†–∞–∑–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚ö†Ô∏è –ù–µ –≤—Å–µ —Ç–∏–ø—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å

### –ü–æ—Å–ª–µ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- ‚úÖ –í—Å–µ —Ç–∏–ø—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤ —Ü–∏–∫–ª–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ï–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ `normalizerRunning`
- ‚úÖ –í—Å–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

---

## üîç –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ Normalizer:

**–ò–Ω—Ç–µ—Ä–≤–∞–ª:** –∫–∞–∂–¥—ã–µ 50 –∑–∞–ø–∏—Å–µ–π

**–ö–æ–¥:**
```go
const stopCheckInterval = 50

for i, item := range items {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–∂–¥—ã–µ N –∑–∞–ø–∏—Å–µ–π
    if i > 0 && i%stopCheckInterval == 0 && n.stopCheck != nil && n.stopCheck() {
        n.sendEvent(fmt.Sprintf("–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ –∑–∞–ø–∏—Å–∏ %d –∏–∑ %d", i, len(items)))
        return fmt.Errorf("normalization stopped by user at item %d of %d", i, len(items))
    }
    // ... –æ–±—Ä–∞–±–æ—Ç–∫–∞
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ CounterpartyNormalizer:

**–ò–Ω—Ç–µ—Ä–≤–∞–ª:** –∫–∞–∂–¥—ã–µ 10 –∑–∞–ø–∏—Å–µ–π (–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)

**–¢–æ—á–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
1. –ü–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º –¥—É–±–ª–µ–π
2. –ü–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –¥—É–±–ª–µ–π
3. –í –≤–æ—Ä–∫–µ—Ä–∞—Ö (2 –º–µ—Å—Ç–∞)
4. –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
5. –ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º ProcessNormalization (3 –º–µ—Å—Ç–∞)

---

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `normalization/normalizer.go`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `stopCheck`
   - –°–æ–∑–¥–∞–Ω `NewNormalizerWithStopCheck`
   - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `SetStopCheck`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Ü–∏–∫–ª

2. `server/server.go`
   - –û–±–Ω–æ–≤–ª–µ–Ω `handleNormalizeStart` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

3. `server/normalization_stop.go` (—Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å)

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ **–∑–∞–≤–µ—Ä—à–µ–Ω–∞**. –¢–µ–ø–µ—Ä—å:

- ‚úÖ **–í—Å–µ —Ç–∏–ø—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞**
- ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π —Ñ–ª–∞–≥ `normalizerRunning`
- ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤ —Ü–∏–∫–ª–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ï–¥–∏–Ω—ã–µ API endpoints –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–ò –ú–û–ñ–ù–û –û–°–¢–ê–ù–û–í–ò–¢–¨ –ò–ó –û–î–ù–û–ì–û –ú–ï–°–¢–ê**

---

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. –î–æ–±–∞–≤–∏—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π endpoint `/api/normalization/stop-all` –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
2. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
3. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —á–∞—Å—Ç–∏—á–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ

