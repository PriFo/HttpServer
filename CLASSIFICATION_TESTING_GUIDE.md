# Руководство по тестированию улучшений классификации

## Быстрый старт

### 1. Перезапустите сервер

```powershell
cd E:\HttpServer
.\restart-server.ps1
```

Или вручную:
```powershell
# Остановите текущий сервер (Ctrl+C)
go build -o httpserver.exe .
.\httpserver.exe
```

### 2. Запустите тесты

```powershell
.\test_classification_improvements.ps1
```

## Что тестируется

Скрипт проверяет 4 проблемных случая, которые раньше классифицировались неправильно:

1. **"mq фасонные элементы /q"**
   - ❌ Было: 96.09.1 (Услуги индивидуальные прочие)
   - ✅ Должно быть: 25.11.11 (Конструкции строительные металлические)

2. **"aks преобразователь (датчик) давления"**
   - ❌ Было: 71.20.1 (Услуги по техническим испытаниям)
   - ✅ Должно быть: 26.51.52 (Приборы для измерения давления)

3. **"helukabel (контрольный) jz-mh"**
   - ❌ Было: 26.12.1 (Платы печатные, смонтированные)
   - ✅ Должно быть: 27.32.11 (Кабели)

4. **"mq фасонные элементы ral sv"**
   - ❌ Было: 32.99.5 (Изделия прочие)
   - ✅ Должно быть: 25.11.11 (Конструкции строительные металлические)

## Ожидаемые результаты

После применения улучшений все тесты должны пройти успешно:

```
✓ УСПЕХ: 25.11.11 - Конструкции строительные металлические
✓ УСПЕХ: 26.51.52 - Приборы для измерения давления
✓ УСПЕХ: 27.32.11 - Кабели
✓ УСПЕХ: 25.11.11 - Конструкции строительные металлические
```

## Ручное тестирование через API

Если хотите протестировать конкретный случай вручную:

```powershell
$body = @{
    normalized_name = "mq фасонные элементы /q"
    category = "стройматериалы"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:9999/api/kpved/classify-hierarchical" `
    -Method POST `
    -Body $body `
    -ContentType "application/json"
```

## Проверка логов

После запуска классификации проверьте логи сервера на наличие:

1. **Сообщений о валидации:**
   ```
   [Validation] Classification corrected for '...': 96.09.1 -> 25.11.11
   ```

2. **Сообщений о keyword-классификации:**
   ```
   [Keyword] Classified '...' as 25.11.11 (...) with confidence 0.95 using keyword matching
   ```

3. **Сообщений о определении типа товара:**
   ```
   [ProductServiceDetector] Detected '...' as PRODUCT (confidence: 0.95, reasoning: ...)
   ```

## Устранение проблем

### Если тесты не проходят:

1. **Проверьте, что сервер перезапущен:**
   - Убедитесь, что используется новый скомпилированный код
   - Проверьте время запуска процесса

2. **Проверьте API ключ:**
   ```powershell
   $env:ARLIAI_API_KEY
   ```

3. **Проверьте логи сервера:**
   - Ищите ошибки с префиксом `[KPVED]` или `[Validation]`
   - Проверьте, что таблица `kpved_classifier` загружена

4. **Проверьте кэш:**
   - Кэш очищается при перезапуске сервера
   - Если нужно, можно очистить вручную через SQL

### Если все еще возникают ошибки:

1. Проверьте, что все файлы сохранены и перекомпилированы
2. Убедитесь, что используется правильная версия Go
3. Проверьте сетевые подключения к Arliai API
4. Проверьте лимиты API (rate limiting)

## Дополнительная проверка

После успешного прохождения тестов можно запустить полную классификацию:

1. Откройте интерфейс управления процессами
2. Нажмите "Запустить классификацию КПВЭД"
3. Следите за прогрессом и логами
4. Проверьте, что процент ошибок значительно снизился

## Метрики успеха

- ✅ Все 4 тестовых случая классифицируются правильно
- ✅ Процент ошибок классификации снижается с ~100% до <10%
- ✅ Товары не классифицируются как услуги
- ✅ Кабели не классифицируются как платы
- ✅ Строительные элементы не классифицируются как услуги

