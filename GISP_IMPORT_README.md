# Импорт эталонов номенклатур из реестра gisp.gov.ru

## Описание

Система импорта эталонов номенклатур из реестра российской промышленной продукции с сайта gisp.gov.ru. При импорте автоматически создаются справочники ОКПД2, ТН ВЭД и ТУ/ГОСТ, а номенклатуры связываются с производителями и справочниками.

## Структура данных

### Справочники

1. **ОКПД2** (`okpd2_classifier`) - Общероссийский классификатор продукции по видам экономической деятельности
2. **ТН ВЭД** (`tnved_reference`) - Товарная номенклатура внешнеэкономической деятельности
3. **ТУ/ГОСТ** (`tu_gost_reference`) - Технические условия и государственные стандарты

### Связи

- Номенклатуры связаны с производителями через `manufacturer_benchmark_id`
- Номенклатуры связаны со справочниками через:
  - `okpd2_reference_id`
  - `tnved_reference_id`
  - `tu_gost_reference_id`

## Использование

### Импорт данных

```bash
go run cmd/import_gisp_nomenclatures/main.go \
  -file "путь/к/файлу/production_res_valid_only.xlsx" \
  -db "./service.db" \
  -verbose
```

Параметры:
- `-file` - путь к Excel-файлу реестра (обязательный)
- `-db` - путь к сервисной базе данных (по умолчанию: `./service.db`)
- `-verbose` - подробный вывод процесса импорта

### Проверка загруженных данных

```bash
go run cmd/check_gisp_nomenclatures/main.go \
  -db "./service.db" \
  -limit 20
```

Параметры:
- `-db` - путь к сервисной базе данных (по умолчанию: `./service.db`)
- `-limit` - количество примеров для отображения (по умолчанию: 10)

## Что происходит при импорте

1. **Парсинг Excel-файла**:
   - Автоматическое определение колонок по заголовкам
   - Извлечение данных о номенклатурах и производителях

2. **Создание/поиск производителей**:
   - Поиск существующих производителей по ИНН или ОГРН
   - Создание новых производителей, если не найдены

3. **Создание записей в справочниках**:
   - ОКПД2 - создается или находится по коду
   - ТН ВЭД - создается или находится по коду
   - ТУ/ГОСТ - создается или находится по коду, определяется тип документа (ТУ/ГОСТ)

4. **Создание эталонов номенклатур**:
   - Связывание с производителем
   - Связывание со справочниками
   - Сохранение дополнительных данных в JSON-атрибутах

## Структура базы данных

### Таблицы справочников

#### `okpd2_classifier`
- `id` - уникальный идентификатор
- `code` - код ОКПД2
- `name` - название
- `parent_code` - код родительской категории
- `level` - уровень в иерархии

#### `tnved_reference`
- `id` - уникальный идентификатор
- `code` - код ТН ВЭД
- `name` - название
- `description` - описание
- `parent_code` - код родительской категории
- `level` - уровень в иерархии
- `source` - источник данных

#### `tu_gost_reference`
- `id` - уникальный идентификатор
- `code` - код ТУ/ГОСТ
- `name` - название
- `document_type` - тип документа ("ТУ" или "ГОСТ")
- `description` - описание
- `source` - источник данных

### Поля в `client_benchmarks`

Для номенклатур:
- `category = 'nomenclature'`
- `manufacturer_benchmark_id` - ссылка на производителя
- `okpd2_reference_id` - ссылка на справочник ОКПД2
- `tnved_reference_id` - ссылка на справочник ТН ВЭД
- `tu_gost_reference_id` - ссылка на справочник ТУ/ГОСТ
- `source_database = 'gisp_gov_ru'`

## Примеры использования

### Полный импорт с проверкой

```bash
# 1. Импорт данных
go run cmd/import_gisp_nomenclatures/main.go \
  -file "/mnt/c/Users/eugin/Downloads/Telegram Desktop/isp/реестр российской промышленной продукции/production_res_valid_only.xlsx" \
  -db "./service.db" \
  -verbose

# 2. Проверка результатов
go run cmd/check_gisp_nomenclatures/main.go \
  -db "./service.db" \
  -limit 20
```

### Проверка статистики

Утилита `check_gisp_nomenclatures` показывает:
- Количество загруженных номенклатур
- Количество созданных производителей
- Статистику по справочникам
- Количество связей между номенклатурами и справочниками
- Примеры загруженных записей
- Топ-10 наиболее используемых кодов в каждом справочнике

## Обработка ошибок

- Если колонка не найдена, парсер попытается найти её по альтернативным названиям
- Записи без названия продукции пропускаются
- Записи без производителя создаются, если есть ИНН или ОГРН
- Ошибки импорта сохраняются в отчете и не прерывают процесс

## Отчеты

После импорта создается файл `gisp_import_report.json` в той же директории, что и база данных, содержащий:
- Общее количество обработанных записей
- Количество успешно импортированных
- Количество обновленных записей
- Список ошибок
- Время выполнения

