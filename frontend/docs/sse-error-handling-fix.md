# Исправление обработки SSE ошибок

## Проблемы

1. **SSE Stream ошибки "terminated"** - логировались как ошибки, хотя это нормальное поведение при закрытии соединения
2. **404 для `/api/logs/client-error`** - эндпоинт не существовал, клиентские ошибки не логировались
3. **404 для `/api/kpved/workers/status`** - возвращалась ошибка вместо пустых данных

## Решения

### 1. Улучшена обработка SSE ошибок

**Файл**: `app/api/monitoring/providers/stream/route.ts`

- ✅ "terminated" и AbortError не логируются как ошибки
- ✅ Использование logger вместо console.error
- ✅ Структурированное логирование с контекстом

**Файл**: `app/monitoring/page.tsx`

- ✅ Улучшена обработка ошибок SSE на клиенте
- ✅ "terminated" и "Stream error" не показываются пользователю

**Файл**: `hooks/use-sse.ts`

- ✅ Игнорирование нормальных закрытий соединения
- ✅ Переподключение только при реальных ошибках

### 2. Создан API роут для логирования клиентских ошибок

**Файлы**:
- ✅ `app/api/logs/client-error/route.ts` - новый роут
- ✅ `app/api/logs/error/route.ts` - роут для совместимости

**Особенности**:
- ✅ Всегда возвращает 200, чтобы избежать циклов ошибок
- ✅ Структурированное логирование через logger
- ✅ Обработка ошибок через withErrorHandler

### 3. Исправлена обработка 404 для workers status

**Файл**: `app/api/kpved/workers/status/route.ts`

- ✅ При 404 возвращаются пустые данные вместо ошибки
- ✅ Использование withErrorHandler и logger
- ✅ Логирование успешных запросов и ошибок

## Результаты

1. **Меньше ложных ошибок** - "terminated" не показывается как ошибка
2. **Логирование клиентских ошибок** - все ошибки теперь логируются на сервере
3. **Лучший UX** - отсутствующие эндпоинты возвращают пустые данные вместо ошибок
4. **Структурированное логирование** - все ошибки логируются с контекстом

## Примеры использования

### SSE Stream

```typescript
// Нормальное закрытие соединения не логируется как ошибка
// Только реальные ошибки логируются
```

### Логирование клиентских ошибок

```typescript
// Автоматически через console-interceptor
// Или вручную:
fetch('/api/logs/client-error', {
  method: 'POST',
  body: JSON.stringify({
    error: 'Error message',
    stack: 'Stack trace',
    timestamp: new Date().toISOString(),
    url: window.location.href,
  }),
})
```

