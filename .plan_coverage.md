# План увеличения покрытия кода тестами до 50-100%

## Текущее состояние

- **Покрытие:** 35.7% (улучшено с 5.3%)
- **Тестов ProcessNormalization:** 19 (все проходят)
- **Качество кода:** ✅ Нет заглушек, все функции реализованы

## Анализ покрытия методов

### Методы CounterpartyNormalizer (14 методов)

#### ✅ Покрыты тестами:
1. `NewCounterpartyNormalizer` - ✅ TestNewCounterpartyNormalizer
2. `sendEvent` - ✅ TestCounterpartyNormalizer_sendEvent, TestCounterpartyNormalizer_sendEvent_NilChannel
3. `ExtractCounterpartyData` - ✅ TestExtractCounterpartyData_*
4. `FindBenchmarkByTaxID` - ✅ TestFindBenchmarkByTaxID_*
5. `NormalizeCounterparty` - ✅ TestNormalizeCounterparty_*
6. `normalizeName` - ✅ TestNormalizeName_*
7. `calculateQualityScore` - ✅ TestCalculateQualityScore_*
8. `ProcessNormalization` - ✅ TestProcessNormalization_* (19 тестов)

#### ❌ НЕ покрыты тестами:
1. `sendStructuredEvent` - ❌ Нет теста
2. `checkStop` - ❌ Нет теста
3. `handleStopSignal` - ❌ Нет теста
4. `addError` - ❌ Нет теста
5. `calculateWorkerCount` - ❌ Нет теста
6. `categorizeErrors` - ❌ Нет теста
7. `ValidateCounterpartyData` - ⚠️ Частично покрыт (нужны edge cases)

## План действий

### Этап 1: Покрытие вспомогательных методов (Цель: 50%)

**Приоритет:** Высокий  
**Оценка времени:** 2-3 часа  
**Ожидаемое покрытие:** 50-55%

#### 1.1. Тесты для `sendStructuredEvent`
**Файл:** `normalization/counterparty_normalizer_test.go`

```go
// TestCounterpartyNormalizer_sendStructuredEvent проверяет отправку структурированных событий
func TestCounterpartyNormalizer_sendStructuredEvent(t *testing.T) {
    // Тест 1: Успешная отправка JSON события
    // Тест 2: Обработка nil канала
    // Тест 3: Обработка переполненного канала
    // Тест 4: Обработка ошибки сериализации JSON
}
```

**Сценарии:**
- ✅ Успешная отправка структурированного события
- ✅ Обработка nil канала (не должно быть паники)
- ✅ Обработка переполненного канала (не должно блокироваться)
- ✅ Обработка ошибки сериализации JSON (fallback на обычное событие)

#### 1.2. Тесты для `checkStop`
**Файл:** `normalization/counterparty_normalizer_test.go`

```go
// TestCounterpartyNormalizer_checkStop проверяет проверку остановки
func TestCounterpartyNormalizer_checkStop(t *testing.T) {
    // Тест 1: stopCheck == nil (должен вернуть false)
    // Тест 2: stopCheck возвращает false
    // Тест 3: stopCheck возвращает true
    // Тест 4: Проверка метрик (recordStopCheck вызывается)
}
```

**Сценарии:**
- ✅ stopCheck == nil → возвращает false
- ✅ stopCheck() == false → возвращает false
- ✅ stopCheck() == true → возвращает true
- ✅ Проверка, что recordStopCheck вызывается с правильными параметрами

#### 1.3. Тесты для `handleStopSignal`
**Файл:** `normalization/counterparty_normalizer_test.go`

```go
// TestCounterpartyNormalizer_handleStopSignal проверяет обработку сигнала остановки
func TestCounterpartyNormalizer_handleStopSignal(t *testing.T) {
    // Тест 1: Обработка остановки с прогрессом
    // Тест 2: Обработка остановки без прогресса (total = 0)
    // Тест 3: Проверка отправки событий
    // Тест 4: Проверка добавления ошибки в результат
}
```

**Сценарии:**
- ✅ Обработка остановки с прогрессом (processed > 0, total > 0)
- ✅ Обработка остановки без прогресса (total = 0)
- ✅ Проверка отправки обычного события
- ✅ Проверка отправки структурированного события
- ✅ Проверка добавления ErrMsgNormalizationStopped в result.Errors

#### 1.4. Тесты для `addError`
**Файл:** `normalization/counterparty_normalizer_test.go`

```go
// TestCounterpartyNormalizer_addError проверяет добавление ошибок
func TestCounterpartyNormalizer_addError(t *testing.T) {
    // Тест 1: Добавление обычной ошибки
    // Тест 2: Добавление ошибки валидации (должно логироваться)
    // Тест 3: Добавление ошибки нормализации (должно логироваться)
    // Тест 4: Добавление нескольких ошибок
}
```

**Сценарии:**
- ✅ Добавление обычной ошибки
- ✅ Добавление ошибки валидации (проверка логирования)
- ✅ Добавление ошибки нормализации (проверка логирования)
- ✅ Добавление нескольких ошибок подряд

#### 1.5. Тесты для `calculateWorkerCount`
**Файл:** `normalization/counterparty_normalizer_test.go`

```go
// TestCounterpartyNormalizer_calculateWorkerCount проверяет расчет количества воркеров
func TestCounterpartyNormalizer_calculateWorkerCount(t *testing.T) {
    // Тест 1: totalItems = 0 → 0 воркеров
    // Тест 2: totalItems < DefaultWorkerCount → totalItems воркеров
    // Тест 3: totalItems == DefaultWorkerCount → DefaultWorkerCount воркеров
    // Тест 4: totalItems > DefaultWorkerCount → DefaultWorkerCount воркеров
}
```

**Сценарии:**
- ✅ totalItems = 0 → возвращает 0
- ✅ totalItems = 5 (меньше DefaultWorkerCount) → возвращает 5
- ✅ totalItems = 10 (равно DefaultWorkerCount) → возвращает 10
- ✅ totalItems = 100 (больше DefaultWorkerCount) → возвращает DefaultWorkerCount

#### 1.6. Тесты для `categorizeErrors`
**Файл:** `normalization/counterparty_normalizer_test.go`

```go
// TestCounterpartyNormalizer_categorizeErrors проверяет категоризацию ошибок
func TestCounterpartyNormalizer_categorizeErrors(t *testing.T) {
    // Тест 1: Категоризация ошибок валидации
    // Тест 2: Категоризация ошибок нормализации
    // Тест 3: Категоризация ошибок сохранения
    // Тест 4: Категоризация других ошибок
    // Тест 5: Смешанные ошибки
    // Тест 6: Пустой список ошибок
}
```

**Сценарии:**
- ✅ Ошибки валидации → stats["validation"]++
- ✅ Ошибки нормализации → stats["normalization"]++
- ✅ Ошибки сохранения → stats["save"]++
- ✅ Другие ошибки → stats["other"]++
- ✅ Смешанные ошибки → правильное распределение
- ✅ Пустой список → все счетчики = 0

#### 1.7. Расширение тестов для `ValidateCounterpartyData`
**Файл:** `normalization/counterparty_normalizer_test.go`

```go
// TestValidateCounterpartyData_EdgeCases проверяет граничные случаи валидации
func TestValidateCounterpartyData_EdgeCases(t *testing.T) {
    // Тест 1: Пустые данные (должна быть ошибка)
    // Тест 2: Только название (должно пройти)
    // Тест 3: Только ИНН (должно пройти)
    // Тест 4: Только БИН (должно пройти)
    // Тест 5: ИНН с пробелами
    // Тест 6: БИН с пробелами
    // Тест 7: ИНН нестандартной длины (должно быть предупреждение)
    // Тест 8: БИН нестандартной длины (должно быть предупреждение)
}
```

**Сценарии:**
- ✅ Пустые данные → ошибка
- ✅ Только название → успех
- ✅ Только ИНН → успех
- ✅ Только БИН → успех
- ✅ ИНН с пробелами → успех (пробелы удаляются)
- ✅ БИН с пробелами → успех (пробелы удаляются)
- ✅ ИНН нестандартной длины → предупреждение в логе, но валидация проходит
- ✅ БИН нестандартной длины → предупреждение в логе, но валидация проходит

### Этап 2: Покрытие edge cases существующих методов (Цель: 70%)

**Приоритет:** Средний  
**Оценка времени:** 3-4 часа  
**Ожидаемое покрытие:** 70-75%

#### 2.1. Расширение тестов для `ExtractCounterpartyData`
**Сценарии:**
- ✅ Пустой CatalogItem
- ✅ CatalogItem с частичными данными
- ✅ CatalogItem с некорректным JSON в Attributes
- ✅ CatalogItem с пустым Attributes
- ✅ CatalogItem с различными форматами данных

#### 2.2. Расширение тестов для `FindBenchmarkByTaxID`
**Сценарии:**
- ✅ Поиск по ИНН (10 цифр)
- ✅ Поиск по ИНН (12 цифр)
- ✅ Поиск по БИН (12 цифр)
- ✅ Поиск несуществующего эталона
- ✅ Поиск с пустой строкой
- ✅ Поиск с пробелами в taxID
- ✅ Ошибка БД при поиске

#### 2.3. Расширение тестов для `NormalizeCounterparty`
**Сценарии:**
- ✅ Нормализация с эталоном (полное дозаполнение)
- ✅ Нормализация с эталоном (частичное дозаполнение)
- ✅ Нормализация без эталона (AI-нормализация)
- ✅ Нормализация без эталона (простая нормализация)
- ✅ Нормализация с AI-нормализатором (успех)
- ✅ Нормализация с AI-нормализатором (ошибка, fallback)
- ✅ Создание эталона (quality score >= MinQualityScoreForBenchmark)
- ✅ Не создание эталона (quality score < MinQualityScoreForBenchmark)
- ✅ Обновление счетчика использования эталона
- ✅ Ошибка при создании эталона (retry логика)

#### 2.4. Расширение тестов для `normalizeName`
**Сценарии:**
- ✅ Пустая строка
- ✅ Только пробелы
- ✅ Специальные символы
- ✅ Много пробелов подряд
- ✅ ОПФ в разных регистрах
- ✅ Смешанные регистры
- ✅ Очень длинное название

#### 2.5. Расширение тестов для `calculateQualityScore`
**Сценарии:**
- ✅ Все поля заполнены → score близок к 1.0
- ✅ Только обязательные поля → score низкий
- ✅ Частично заполненные поля → score средний
- ✅ Пустые поля → score минимальный
- ✅ Различные комбинации полей

#### 2.6. Расширение тестов для `ProcessNormalization`
**Сценарии:**
- ✅ skipNormalized = true (пропуск уже нормализованных)
- ✅ skipNormalized = false (обработка всех)
- ✅ Обработка с ошибками валидации
- ✅ Обработка с ошибками нормализации
- ✅ Обработка с ошибками сохранения
- ✅ Обработка с паникой в воркере (recover)
- ✅ Обработка с пустым списком контрагентов
- ✅ Обработка с очень большим списком контрагентов
- ✅ Обработка с различными комбинациями дублей

### Этап 3: Интеграционные тесты и race conditions (Цель: 85%)

**Приоритет:** Средний  
**Оценка времени:** 2-3 часа  
**Ожидаемое покрытие:** 85-90%

#### 3.1. Тесты для параллельной обработки
**Файл:** `normalization/counterparty_normalizer_enterprise_test.go`

**Сценарии:**
- ✅ Параллельная обработка с несколькими воркерами
- ✅ Остановка во время параллельной обработки
- ✅ Race condition при остановке
- ✅ Race condition при обновлении статистики
- ✅ Обработка результатов из разных воркеров

#### 3.2. Тесты для интеграции с БД
**Файл:** `normalization/counterparty_normalizer_integration_test.go` (новый файл)

**Сценарии:**
- ✅ Полный цикл нормализации с сохранением в БД
- ✅ Создание эталонов в БД
- ✅ Поиск эталонов в БД
- ✅ Обновление счетчиков эталонов
- ✅ Обработка ошибок БД

### Этап 4: Покрытие всех веток кода (Цель: 95-100%)

**Приоритет:** Низкий  
**Оценка времени:** 3-4 часа  
**Ожидаемое покрытие:** 95-100%

#### 4.1. Покрытие всех if/else веток
- ✅ Все условия в ProcessNormalization
- ✅ Все условия в NormalizeCounterparty
- ✅ Все условия в ExtractCounterpartyData
- ✅ Все условия в других методах

#### 4.2. Покрытие всех error paths
- ✅ Все возможные ошибки БД
- ✅ Все возможные ошибки валидации
- ✅ Все возможные ошибки нормализации
- ✅ Все возможные ошибки сохранения

#### 4.3. Покрытие всех edge cases
- ✅ Nil указатели
- ✅ Пустые строки
- ✅ Очень длинные строки
- ✅ Специальные символы
- ✅ Граничные значения

## Метрики успеха

### Минимальная цель (50%):
- ✅ Все вспомогательные методы покрыты тестами
- ✅ Основные edge cases покрыты
- ✅ Все тесты проходят

### Целевая цель (70%):
- ✅ Все методы покрыты тестами
- ✅ Большинство edge cases покрыты
- ✅ Интеграционные тесты добавлены

### Идеальная цель (95-100%):
- ✅ Все ветки кода покрыты
- ✅ Все error paths покрыты
- ✅ Все edge cases покрыты
- ✅ Race conditions протестированы

## Чеклист выполнения

### Этап 1 (50%):
- [ ] Тесты для sendStructuredEvent
- [ ] Тесты для checkStop
- [ ] Тесты для handleStopSignal
- [ ] Тесты для addError
- [ ] Тесты для calculateWorkerCount
- [ ] Тесты для categorizeErrors
- [ ] Расширение тестов для ValidateCounterpartyData

### Этап 2 (70%):
- [ ] Расширение тестов для ExtractCounterpartyData
- [ ] Расширение тестов для FindBenchmarkByTaxID
- [ ] Расширение тестов для NormalizeCounterparty
- [ ] Расширение тестов для normalizeName
- [ ] Расширение тестов для calculateQualityScore
- [ ] Расширение тестов для ProcessNormalization

### Этап 3 (85%):
- [ ] Тесты для параллельной обработки
- [ ] Тесты для race conditions
- [ ] Интеграционные тесты с БД

### Этап 4 (95-100%):
- [ ] Покрытие всех веток кода
- [ ] Покрытие всех error paths
- [ ] Покрытие всех edge cases

## Инструменты для проверки покрытия

```bash
# Генерация отчета о покрытии
go test ./normalization -coverprofile=coverage.out -covermode=atomic

# Просмотр покрытия по функциям
go tool cover -func=coverage.out

# Просмотр покрытия в HTML
go tool cover -html=coverage.out -o coverage.html

# Проверка покрытия конкретного файла
go tool cover -func=coverage.out | grep counterparty_normalizer.go
```

## Приоритизация

1. **Высокий приоритет:** Этап 1 (вспомогательные методы) - быстро увеличит покрытие до 50%
2. **Средний приоритет:** Этап 2 (edge cases) - увеличит покрытие до 70%
3. **Средний приоритет:** Этап 3 (интеграционные тесты) - увеличит покрытие до 85%
4. **Низкий приоритет:** Этап 4 (100% покрытие) - финальная полировка

## Оценка времени

- **Этап 1:** 2-3 часа → 50% покрытие
- **Этап 2:** 3-4 часа → 70% покрытие
- **Этап 3:** 2-3 часа → 85% покрытие
- **Этап 4:** 3-4 часа → 95-100% покрытие

**Итого:** 10-14 часов работы для достижения 95-100% покрытия

