# Инструкция по перезапуску сервера для применения улучшений классификации

## Проблема

Сервер запущен со старым кодом (PID 25704, запущен в 6:45:06), поэтому изменения в классификации не применяются. Все группы (12 697) завершились с ошибкой, возможно из-за использования старого алгоритма.

## Решение

### 1. Остановить текущий сервер

```powershell
# Найти процесс сервера
Get-Process | Where-Object {$_.ProcessName -like "*httpserver*"}

# Остановить процесс (замените PID на актуальный)
Stop-Process -Id 25704 -Force
```

Или через интерфейс:
- Закройте окно сервера, если оно открыто
- Или используйте Ctrl+C в терминале, где запущен сервер

### 2. Пересобрать проект

```powershell
cd E:\HttpServer
go build -o httpserver.exe .
```

### 3. Запустить сервер заново

```powershell
# Убедитесь, что установлена переменная окружения с API ключом
$env:ARLIAI_API_KEY = "ваш-api-ключ"

# Запустите сервер
.\httpserver.exe
```

Или используйте скрипт запуска:
```powershell
.\start-dev.ps1
```

### 4. Проверить, что новый код загружен

После перезапуска сервер будет:
- ✅ Использовать улучшенные промпты с правилами разграничения товаров/услуг
- ✅ Использовать улучшенный keyword-классификатор с логикой определения товаров
- ✅ Применять пост-обработку для исправления ошибок классификации
- ✅ Использовать улучшенные промпты AI-классификатора

### 5. Очистить кэш классификации (опционально)

Кэш создается заново при каждом запросе, но если хотите очистить старые результаты:

```sql
-- Очистить кэш можно через SQL (если используется persistent cache)
-- Но обычно кэш хранится в памяти и очищается при перезапуске
```

### 6. Запустить классификацию заново

После перезапуска сервера:
1. Откройте интерфейс управления процессами
2. Нажмите "Запустить классификацию КПВЭД"
3. Следите за логами сервера для проверки работы

### 7. Проверить логи на ошибки

После запуска классификации проверьте логи сервера. Ожидаемые улучшения:
- ✅ Товары не должны классифицироваться как услуги
- ✅ "mq фасонные элементы" → строительные материалы (25.11.11), НЕ услуги (96.09.1)
- ✅ "aks преобразователь давления" → приборы (26.51.52), НЕ услуги (71.20.1)
- ✅ "helukabel контрольный кабель" → кабели (27.32.11), НЕ платы (26.12.1)

## Важные замечания

1. **Классификатор создается заново при каждом запросе** (строка 7482 в server.go), поэтому после перезапуска сервера будет использоваться новый код
2. **Кэш хранится в памяти** и очищается при перезапуске сервера
3. **Воркеры работают параллельно** (максимум 2 воркера из-за ограничений Arliai API)
4. **Все изменения применены** в коде, нужно только перезапустить сервер

## Если ошибки продолжаются

Если после перезапуска все еще возникают ошибки:

1. Проверьте логи сервера на конкретные ошибки
2. Убедитесь, что API ключ Arliai настроен правильно
3. Проверьте, что таблица `kpved_classifier` загружена и содержит данные
4. Проверьте сетевые подключения к Arliai API

## Проверка работы улучшений

После перезапуска можно протестировать на проблемных случаях через API:

```powershell
# Тест 1: Фасонные элементы
$body = @{
    normalized_name = "mq фасонные элементы /q"
    category = "стройматериалы"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/kpved/classify-hierarchical" -Method POST -Body $body -ContentType "application/json"

# Тест 2: Преобразователь давления
$body = @{
    normalized_name = "aks преобразователь (датчик) давления"
    category = "оборудование"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/kpved/classify-hierarchical" -Method POST -Body $body -ContentType "application/json"

# Тест 3: Контрольный кабель
$body = @{
    normalized_name = "helukabel (контрольный) jz-mh"
    category = "электроника"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/kpved/classify-hierarchical" -Method POST -Body $body -ContentType "application/json"
```

Ожидаемые результаты:
- Фасонные элементы → 25.11.11 (Конструкции строительные металлические), НЕ 96.09.1
- Преобразователь давления → 26.51.52 (Приборы измерения давления), НЕ 71.20.1
- Контрольный кабель → 27.32.11 (Кабели), НЕ 26.12.1

