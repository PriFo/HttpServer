# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ 500 –û—à–∏–±–∫–∏ –ø—Ä–∏ –ó–∞–≥—Ä—É–∑–∫–µ –ë–î

**–î–∞—Ç–∞:** 2025-11-26  
**–ü—Ä–æ–±–ª–µ–º–∞:** `POST /api/clients/1/projects/1/databases` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 500 Internal Server Error  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**

---

## üîç –ü—Ä–æ–±–ª–µ–º–∞

Frontend –ø–æ–ª—É—á–∞–ª –æ—à–∏–±–∫—É `500 Internal Server Error` –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑:
```
POST http://localhost:3000/api/clients/1/projects/1/databases
```

---

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–Ω–∏–∫ –≤ `handleUploadProjectDatabase`

**–§–∞–π–ª:** `server/client_legacy_handlers.go` (—Å—Ç—Ä–æ–∫–∞ 2871)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ `defer recover()` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–Ω–∏–∫
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `s.serviceDB == nil` –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫

**–ö–æ–¥:**
```go
func (s *Server) handleUploadProjectDatabase(...) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–Ω–∏–∫
    defer func() {
        if rec := recover(); rec != nil {
            log.Printf("[handleUploadProjectDatabase] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê (panic): %v\n%s", rec, debug.Stack())
            s.writeJSONError(w, r, fmt.Sprintf("Internal server error: %v", rec), http.StatusInternalServerError)
        }
    }()

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ serviceDB
    if s.serviceDB == nil {
        log.Printf("[handleUploadProjectDatabase] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: serviceDB is nil")
        s.writeJSONError(w, r, "Service database not available", http.StatusInternalServerError)
        return
    }
    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

### 2. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–∞–Ω–∏–∫ –≤ `handleCreateProjectDatabase`

**–§–∞–π–ª:** `server/client_legacy_handlers.go` (—Å—Ç—Ä–æ–∫–∞ 2168)

**–î–æ–±–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ `defer recover()` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–Ω–∏–∫
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ `s.serviceDB == nil` –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 3. ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã `LogNormalizationError`

**–§–∞–π–ª:** `server/normalization_legacy_handlers.go`

**–ü—Ä–æ–±–ª–µ–º–∞:** –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–ª–∞—Å—å —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** –£–±—Ä–∞–Ω—ã –ª–∏—à–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ 8 –≤—ã–∑–æ–≤–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏

**–ë—ã–ª–æ:**
```go
LogNormalizationError(clientID, projectID, projectDB.ID, err, "message")
```

**–°—Ç–∞–ª–æ:**
```go
LogNormalizationError(clientID, projectID, err, "message")
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è:
```bash
$ go build ./cmd/server
‚úÖ –£—Å–ø–µ—à–Ω–æ! –ù–µ—Ç –æ—à–∏–±–æ–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏
```

### ‚úÖ –ó–∞—â–∏—Ç–∞:
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–∞–Ω–∏–∫ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–∞—à —Å–µ—Ä–≤–µ—Ä–∞
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ nil –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—Ç nil pointer dereference
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–æ–≥–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã

---

## üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### 1. ‚úÖ `diagnose-500-error.ps1`
**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ 500 –æ—à–∏–±–æ–∫

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```powershell
.\diagnose-500-error.ps1
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–ø—É—â–µ–Ω –ª–∏ backend
- –î–∞–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—É –ª–æ–≥–æ–≤
- –û–±—ä—è—Å–Ω—è–µ—Ç, —á—Ç–æ –∏—Å–∫–∞—Ç—å –≤ –ª–æ–≥–∞—Ö
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–∏–ø–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

---

## üîç –ö–∞–∫ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å 500 –û—à–∏–±–∫–∏

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç—å Backend
```powershell
.\start-backend.ps1
```

### –®–∞–≥ 2: –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –û—à–∏–±–∫—É
–í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤ UI, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É 500

### –®–∞–≥ 3: –°–º–æ—Ç—Ä–µ—Ç—å –õ–æ–≥–∏ Backend
–í –æ–∫–Ω–µ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ —Å backend –∏—â–∏—Ç–µ:
- `ERROR` –∏–ª–∏ `FATAL`
- `panic:`
- `sql:`
- `runtime error:`
- `nil pointer`

### –®–∞–≥ 4: –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –û—à–∏–±–∫—É
–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –æ—à–∏–±–∫–∏ –∏ 5-10 —Å—Ç—Ä–æ–∫ –¥–æ/–ø–æ—Å–ª–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

---

## üìù –¢–∏–ø–∏—á–Ω—ã–µ –ü—Ä–∏—á–∏–Ω—ã 500 –û—à–∏–±–æ–∫

### 1. `serviceDB is nil`
**–°–∏–º–ø—Ç–æ–º:** `nil pointer dereference`  
**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–π

### 2. `sql: database is closed`
**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ë–î  
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ë–î –Ω–µ –∑–∞–∫—Ä—ã—Ç–∞ –ø—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ

### 3. `FOREIGN KEY constraint failed`
**–°–∏–º–ø—Ç–æ–º:** –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–ø–∏—Å–∏  
**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ–µ–∫—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

### 4. `panic: runtime error`
**–°–∏–º–ø—Ç–æ–º:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞  
**–†–µ—à–µ–Ω–∏–µ:** ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω recover –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–∞–Ω–∏–∫

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ü–æ—Å–ª–µ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

1. **–ö–æ–º–ø–∏–ª—è—Ü–∏—è:**
   ```powershell
   go build ./cmd/server
   ```
   ‚úÖ –£—Å–ø–µ—à–Ω–æ

2. **–ó–∞–ø—É—Å–∫:**
   ```powershell
   .\start-backend.ps1
   ```
   ‚úÖ Backend –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**
   - –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ UI
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ backend –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
   - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –≤—Å–µ –µ—â–µ –µ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `diagnose-500-error.ps1`

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ –®–∞–≥–∏

1. ‚úÖ **–ó–∞–ø—É—Å—Ç–∏—Ç—å backend:** `.\start-backend.ps1`
2. ‚úÖ **–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ë–î** —á–µ—Ä–µ–∑ UI
3. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏** backend –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
4. ‚úÖ **–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –µ—Å—Ç—å** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `diagnose-500-error.ps1` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## üìÑ –°–≤—è–∑–∞–Ω–Ω—ã–µ –§–∞–π–ª—ã

- `server/client_legacy_handlers.go` - –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –ë–î
- `server/normalization_legacy_handlers.go` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–≥–µ—Ä–∞
- `diagnose-500-error.ps1` - –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
- `DATABASE_UPLOAD_FIX.md` - –ø—Ä–µ–¥—ã–¥—É—â–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

---

**–í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!** ‚úÖ

Backend —Ç–µ–ø–µ—Ä—å –∑–∞—â–∏—â–µ–Ω –æ—Ç –ø–∞–Ω–∏–∫ –∏ –∏–º–µ–µ—Ç —É–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º.

