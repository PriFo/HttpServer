# Workflow добавления новой базы данных

> **Быстрая справка** для добавления новых БД к проекту

---

## 🚀 Быстрый старт (3 шага)

```
1. ЗАГРУЗИТЬ   →  2. ЗАРЕГИСТРИРОВАТЬ  →  3. ПРОВЕРИТЬ
   POST /api/upload   POST /api/.../databases   GET /api/.../preview-stats
```

---

## 📊 Полный процесс

```
┌─────────────────────────────────────────────────────────────┐
│ ФАЙЛ БД                                                     │
│ Выгрузка_Номенклатура_ERPWE_2025.db                        │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 1: ЗАГРУЗКА НА СЕРВЕР                                  │
│ POST /api/upload                                            │
│ → Файл копируется в /uploads/                              │
│ → Возвращается upload_id и file_path                       │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 2: РЕГИСТРАЦИЯ В ПРОЕКТЕ                               │
│ POST /api/clients/1/projects/3/databases                    │
│ → БД добавляется к проекту                                  │
│ → Получает уникальный database_id                          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ АВТООПРЕДЕЛЕНИЕ ТИПА                                        │
│                                                             │
│ ┌─────────────────────────────────────────────────────────┐│
│ │ Метод 1: Проверка таблицы catalogs                      ││
│ │ ─────────────────────────────────────────────────────── ││
│ │ SELECT EXISTS (                                          ││
│ │   SELECT 1 FROM catalogs                                 ││
│ │   WHERE name = 'Номенклатура'                            ││
│ │ )                                                        ││
│ │                                                          ││
│ │ Если найдено ✅ → DataType = "nomenclature"             ││
│ └─────────────────────────────────────────────────────────┘│
│                        │                                     │
│                        ▼ (если не найдено)                  │
│ ┌─────────────────────────────────────────────────────────┐│
│ │ Метод 2: Парсинг имени файла (fallback)                 ││
│ │ ─────────────────────────────────────────────────────── ││
│ │ fileName = "Выгрузка_Номенклатура_ERPWE_2025.db"         ││
│ │ fileInfo = ParseDatabaseFileInfo(fileName)              ││
│ │                                                          ││
│ │ fileInfo.DataType = "nomenclature" ✅                    ││
│ └─────────────────────────────────────────────────────────┘│
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ ПОДСЧЕТ ЗАПИСЕЙ                                             │
│                                                             │
│ SELECT COUNT(*) FROM catalog_items                          │
│ → count = 10,500                                            │
│                                                             │
│ if (DataType == "nomenclature") {                           │
│     nomenclatureCount = 10,500 ✅                           │
│     counterpartyCount = 0                                   │
│ }                                                           │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
┌─────────────────────────────────────────────────────────────┐
│ ШАГ 3: ОБНОВЛЕНИЕ СТАТИСТИКИ                               │
│ GET /api/clients/1/projects/3/normalization/preview-stats  │
│                                                             │
│ БЫЛО:                         СТАЛО:                        │
│ ─────────────────────────────────────────────────────────  │
│ total_databases: 7            total_databases: 8 ✅         │
│ total_nomenclature: 27,878    total_nomenclature: 38,378 ✅ │
│ total_counterparties: 20,571  total_counterparties: 20,571 │
└─────────────────────────────────────────────────────────────┘
```

---

## ✅ Гарантии корректности

| Проверка | Статус | Детали |
|----------|--------|--------|
| **Автоопределение типа** | ✅ | 2 метода (каталог + имя файла) |
| **Правильный подсчет** | ✅ | 100% точность на 7 БД |
| **Обновление статистики** | ✅ | Автоматически |
| **Нет перемешивания** | ✅ | Каждый тип отдельно |

---

## 🎯 Примеры

### Пример 1: Номенклатура

```bash
# Файл: Выгрузка_Номенклатура_1C_2025.db
# Записей: 5,000

РЕЗУЛЬТАТ:
├─ total_nomenclature: +5,000 ✅
├─ total_counterparties: 0
└─ total_databases: +1
```

### Пример 2: Контрагенты

```bash
# Файл: Выгрузка_Контрагенты_CRM_2025.db
# Записей: 3,000

РЕЗУЛЬТАТ:
├─ total_nomenclature: 0
├─ total_counterparties: +3,000 ✅
└─ total_databases: +1
```

---

## 🔍 Проверка результата

После добавления новой БД:

```bash
# 1. Проверить список БД
GET /api/clients/1/projects/3/databases

# 2. Проверить статистику
GET /api/clients/1/projects/3/normalization/preview-stats

# 3. Проверить детали БД
GET /api/clients/1/projects/3/databases/{database_id}
```

**Ожидаемый результат:**

✅ Новая БД в списке  
✅ Статистика обновлена  
✅ Тип определен правильно  
✅ Записи подсчитаны корректно  

---

## 📝 Команды для быстрого теста

### PowerShell
```powershell
# 1. Загрузить файл
$response = Invoke-RestMethod -Uri "http://localhost:9999/api/upload" `
  -Method POST `
  -Form @{
    file = Get-Item "путь\к\файлу.db"
    client_id = 1
    project_id = 3
  }

# 2. Зарегистрировать БД
$dbData = @{
  name = "Новая БД"
  file_path = $response.file_path
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:9999/api/clients/1/projects/3/databases" `
  -Method POST `
  -Body $dbData `
  -ContentType "application/json"

# 3. Проверить статистику
Invoke-RestMethod -Uri "http://localhost:9999/api/clients/1/projects/3/normalization/preview-stats"
```

### curl
```bash
# 1. Загрузить файл
curl -X POST http://localhost:9999/api/upload \
  -F "file=@/path/to/file.db" \
  -F "client_id=1" \
  -F "project_id=3"

# 2. Зарегистрировать БД
curl -X POST http://localhost:9999/api/clients/1/projects/3/databases \
  -H "Content-Type: application/json" \
  -d '{"name": "Новая БД", "file_path": "/uploads/file.db"}'

# 3. Проверить статистику
curl http://localhost:9999/api/clients/1/projects/3/normalization/preview-stats
```

---

## ⚠️ Важно помнить

### Именование файлов

```
✅ ПРАВИЛЬНО:
Выгрузка_Номенклатура_ERPWE_2025.db
Выгрузка_Контрагенты_1C_2025.db

⚠️ РАБОТАЕТ (через каталог):
custom_name.db (если есть таблица catalogs)

❌ МОЖЕТ НЕ РАБОТАТЬ:
random_file_123.db (без catalogs и без типа в имени)
```

### Структура БД

```
ОБЯЗАТЕЛЬНО:
✅ Таблица: catalog_items
✅ Поле: id, name

ОПЦИОНАЛЬНО:
⚠️ Таблица: catalogs (для автоопределения)
⚠️ Поле: code, reference
```

---

**Статус:** ✅ ГОТОВО К ИСПОЛЬЗОВАНИЮ  
**Дата:** 2025-11-26

