# –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏—è–º–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### 1. –ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `priority` –≤ —Ç–∞–±–ª–∏—Ü—É `normalization_sessions`
- ‚úÖ API endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞: `POST /api/clients/{clientId}/projects/{projectId}/normalization/sessions`
- ‚úÖ –°–µ—Å—Å–∏–∏ —Å–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç DESC, –∑–∞—Ç–µ–º started_at ASC)

### 2. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Å—Å–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å—Ç–∞—Ç—É—Å `stopped` –≤ —Ç–∞–±–ª–∏—Ü—É `normalization_sessions`
- ‚úÖ API endpoint –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–µ—Å—Å–∏–∏: `POST /api/clients/{clientId}/projects/{projectId}/normalization/sessions/{sessionId}`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `handleStopClientNormalization` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ `session_id`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Å—Å–∏–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –ø—Ä–æ–µ–∫—Ç–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

### 3. –ó–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `timeout_seconds` –≤ —Ç–∞–±–ª–∏—Ü—É `normalization_sessions` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 3600 —Å–µ–∫—É–Ω–¥ = 1 —á–∞—Å)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `last_activity_at` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- ‚úÖ –§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ `startSessionTimeoutChecker()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ —Å–µ—Å—Å–∏–∏ –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- ‚úÖ –ú–µ—Ç–æ–¥ `CheckAndMarkTimeoutSessions()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞–µ—Ç –∑–∞–≤–∏—Å—à–∏–µ —Å–µ—Å—Å–∏–∏ –∫–∞–∫ `timeout`
- ‚úÖ –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏ (–∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥) –≤–æ –≤—Ä–µ–º—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

## üìã API Endpoints

### GET /api/clients/{clientId}/projects/{projectId}/normalization/sessions
–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–µ—Å—Å–∏–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞.

**–û—Ç–≤–µ—Ç:**
```json
{
  "sessions": [
    {
      "id": 1,
      "project_database_id": 1,
      "database_name": "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö 1",
      "database_path": "/path/to/db.db",
      "started_at": "2025-01-20T10:00:00Z",
      "status": "running",
      "priority": 0,
      "timeout_seconds": 3600,
      "last_activity_at": "2025-01-20T10:05:00Z",
      "finished_at": null
    }
  ],
  "total": 1
}
```

### POST /api/clients/{clientId}/projects/{projectId}/normalization/sessions
–û–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Å–µ—Å—Å–∏–∏.

**–¢–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "session_id": 1,
  "priority": 10
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "session_id": 1,
  "priority": 10
}
```

### POST /api/clients/{clientId}/projects/{projectId}/normalization/sessions/{sessionId}
–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–µ—Å—Å–∏—é –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏.

**–û—Ç–≤–µ—Ç:**
```json
{
  "success": true,
  "session_id": 1,
  "message": "Session stopped successfully"
}
```

### POST /api/clients/{clientId}/projects/{projectId}/normalization/stop?session_id={sessionId}
–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–ø—Ä–æ—Å–∞ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±).

## üîß –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏
–í–æ –≤—Ä–µ–º—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è:
- –ü—Ä–∏ –Ω–∞—á–∞–ª–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
- –ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- –ü—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å—à–∏—Ö —Å–µ—Å—Å–∏–π
–§–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞ –∏:
- –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ —Å–µ—Å—Å–∏–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `running`
- –ü–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ `timeout` —Å–µ—Å—Å–∏–∏, –≥–¥–µ `(now - last_activity_at) > timeout_seconds`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
–í –ø—Ä–æ—Ü–µ—Å—Å–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:
- –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏
- –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –Ω–µ –±—ã–ª–∞ –ª–∏ —Å–µ—Å—Å–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
- –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç `test_session_management.sh` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:

```bash
bash test_session_management.sh
```

–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Å—Å–∏–π
2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ —Å–µ—Å—Å–∏–∏
4. –û—Å—Ç–∞–Ω–æ–≤–∫—É —Å–µ—Å—Å–∏–∏
5. –ü—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞ –ø–æ—Å–ª–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

## üìä –°—Ç–∞—Ç—É—Å—ã —Å–µ—Å—Å–∏–π

- `running` - —Å–µ—Å—Å–∏—è –∞–∫—Ç–∏–≤–Ω–∞ –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
- `completed` - —Å–µ—Å—Å–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞
- `failed` - —Å–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π
- `stopped` - —Å–µ—Å—Å–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- `timeout` - —Å–µ—Å—Å–∏—è –∑–∞–≤–∏—Å–ª–∞ –∏ –±—ã–ª–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–µ–Ω–∞ –∫–∞–∫ timeout

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- **–î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ç–∞–π–º–∞—É—Ç**: 3600 —Å–µ–∫—É–Ω–¥ (1 —á–∞—Å)
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–∏—Å—à–∏—Ö —Å–µ—Å—Å–∏–π**: 1 –º–∏–Ω—É—Ç–∞
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**: 30 —Å–µ–∫—É–Ω–¥
- **–î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: 0

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ —Å–µ—Å—Å–∏–∏ –∫ –ø—Ä–æ–µ–∫—Ç—É –ø–µ—Ä–µ–¥ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏
- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —á—É–∂–∏—Ö —Å–µ—Å—Å–∏–π

