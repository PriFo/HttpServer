# Chaos Monkey Backend Testing

Набор нагрузочных и нестандартных тестов для выявления слабых мест в бэкенде после рефакторинга.

## Описание

Эти тесты проверяют:
- **Конкурентные обновления конфигурации** - race conditions и блокировки БД
- **Нормализация с невалидными данными** - валидация и обработка ошибок
- **Устойчивость к сбоям AI** - обработка ошибок при недоступности AI сервиса
- **Работа с большими объемами** - мониторинг ресурсов и производительности

## Требования

### Для Bash-скриптов:
- Bash (Git Bash на Windows, или Linux/WSL)
- `curl` для HTTP запросов
- `jq` для парсинга JSON
- `bc` для математических операций

### Для Python-версии (рекомендуется):
- Python 3.7+
- `requests` библиотека
- `psutil` библиотека

**Установка зависимостей Python:**
```bash
pip install -r requirements.txt
```

**Перед запуском тестов:**
- Сервер должен быть запущен на `http://localhost:9999`
- Рекомендуется запустить `diagnostic.sh` для проверки окружения

## Структура

```
chaos_tests/
├── diagnostic.sh                  # Диагностический скрипт (проверка окружения)
├── chaos_monkey.py                # Python-версия всех тестов (кросс-платформенная) ⭐
├── test_connection.py             # Быстрая проверка подключения к серверу
├── run_quick_test.py              # Быстрый тест работоспособности
├── improved_base_test.py          # Улучшенный базовый класс (для расширения)
├── requirements.txt               # Python зависимости
├── utils.sh                       # Общие утилиты (для Bash-скриптов)
├── test_concurrent_config.sh      # Конкурентные обновления конфигурации (Bash)
├── test_invalid_normalization.sh  # Невалидные данные для нормализации (Bash)
├── test_ai_failure.sh             # Тесты устойчивости к сбоям AI (Bash)
├── test_large_data.sh             # Тесты с большими объемами (Bash)
├── run_all_tests.sh               # Запуск всех Bash-тестов
├── CHAOS_TEST_REPORT.md           # Шаблон сводного отчета
├── logs/                          # Логи тестов (создается автоматически)
└── reports/                       # Отчеты по тестам (создается автоматически)
```

## Использование

### Шаг 0: Быстрая проверка подключения

```bash
cd chaos_tests
python3 test_connection.py
# или
python chaos_tests/test_connection.py
```

Этот скрипт быстро проверит доступность сервера и время ответа.

### Шаг 1: Проверка окружения (рекомендуется)

```bash
cd chaos_tests
bash diagnostic.sh
```

Этот скрипт проверит:
- Наличие всех зависимостей
- Доступность бэкенда
- Корректность конфигурации

### Шаг 2: Запуск тестов

#### Вариант A: Python-версия (рекомендуется, кросс-платформенная)

```bash
cd chaos_tests

# Установка зависимостей (один раз)
pip install -r requirements.txt

# Запуск всех тестов
python chaos_monkey.py --test all

# Запуск отдельного теста
python chaos_monkey.py --test concurrent_config
python chaos_monkey.py --test invalid_normalization
python chaos_monkey.py --test ai_failure
python chaos_monkey.py --test large_data
```

#### Вариант B: Bash-скрипты (требует WSL/Git Bash на Windows)

```bash
cd chaos_tests

# Запуск всех тестов
bash run_all_tests.sh

# Запуск отдельного теста
bash test_concurrent_config.sh
bash test_invalid_normalization.sh
bash test_ai_failure.sh
bash test_large_data.sh
```

### Настройка

Можно изменить настройки через переменные окружения:

```bash
export BASE_URL="http://localhost:9999"
export LOG_DIR="./chaos_tests/logs"
export REPORT_DIR="./chaos_tests/reports"
```

## Тесты

### 1. test_concurrent_config.sh

Проверяет обработку параллельных обновлений конфигурации:
- Запускает 10 параллельных PUT /api/config запросов
- Проверяет на ошибки блокировки БД
- Анализирует историю конфигурации на пропуски версий
- Восстанавливает исходную конфигурацию

**Ожидаемые проблемы:**
- Race conditions в `SaveAppConfigWithHistory`
- Ошибки "database is locked"
- Пропуски версий в истории

### 2. test_invalid_normalization.sh

Проверяет валидацию входных данных:
- Несуществующий database_id
- Невалидный item_id (0)
- Пустой original_name
- Отрицательный лимит в истории
- Несуществующий session_id
- Невалидный JSON

**Ожидаемые проблемы:**
- Отсутствие валидации входных данных
- Непонятные сообщения об ошибках

### 3. test_ai_failure.sh

Проверяет устойчивость к сбоям AI сервиса:
- Устанавливает невалидный API ключ
- Запускает полный цикл нормализации
- Проверяет статус сессии после ошибки
- Проверяет логи на наличие ошибок
- Восстанавливает валидный API ключ

**Ожидаемые проблемы:**
- Сессии не помечаются как 'failed' при ошибках AI
- Недостаточное логирование ошибок

### 4. test_large_data.sh

Мониторит ресурсы при больших объемах данных:
- Базовый мониторинг ресурсов (60 секунд)
- Мониторинг во время нормализации
- Проверка таймаутов
- Анализ использования CPU и памяти

**Ожидаемые проблемы:**
- Утечки памяти
- Высокая нагрузка CPU
- Долгие таймауты

## Отчеты

Каждый тест генерирует отдельный отчет в `reports/`:
- `concurrent_config_YYYYMMDD_HHMMSS.md`
- `invalid_normalization_YYYYMMDD_HHMMSS.md`
- `ai_failure_YYYYMMDD_HHMMSS.md`
- `large_data_YYYYMMDD_HHMMSS.md`

Сводный отчет: `CHAOS_TEST_REPORT.md`

## Логи

Все логи сохраняются в `logs/chaos_test_YYYYMMDD.log`

## Интерпретация результатов

### Успешные тесты
- ✅ Все запросы успешны
- ✅ Нет ошибок блокировки БД
- ✅ Корректная обработка невалидных данных
- ✅ Сессии корректно помечаются как failed
- ✅ Нет утечек памяти

### Проблемы
- ⚠️ Ошибки блокировки БД → нужны транзакции
- ⚠️ Невалидные данные не обрабатываются → нужна валидация
- ⚠️ Сессии не помечаются как failed → нужна обработка ошибок
- ⚠️ Утечки памяти → нужна оптимизация

## Рекомендации по исправлению

### Race conditions в конфигурации
1. Добавить транзакции в `database/service_db.go:SaveAppConfigWithHistory`
2. Реализовать retry механизм с экспоненциальной задержкой
3. Использовать оптимистичную блокировку через версионирование

### Обработка ошибок AI
1. Убедиться, что сессии получают статус 'failed' при ошибках
2. Улучшить логирование ошибок
3. Добавить retry логику с экспоненциальной задержкой

### Валидация входных данных
1. Добавить валидацию на уровне handlers
2. Улучшить сообщения об ошибках
3. Проверять существование database_id перед запуском

### Ресурсы
1. Регулярно мониторить использование памяти
2. Оптимизировать запросы к БД
3. Использовать пагинацию для больших результатов

## Примечания

- Тесты могут изменить конфигурацию сервера (восстанавливается автоматически)
- Некоторые тесты требуют наличия клиентов и проектов в БД
- Тесты могут занять значительное время (особенно test_large_data.sh)
- Рекомендуется запускать тесты на тестовом окружении

