# Быстрый старт - Chaos Monkey Testing

## Рекомендуемый способ (Python - кросс-платформенный)

```bash
cd chaos_tests

# 1. Установка зависимостей (один раз)
pip install -r requirements.txt

# 2. Проверка окружения (рекомендуется)
python chaos_monkey.py --test all  # или bash diagnostic.sh

# 3. Запуск всех тестов
python chaos_monkey.py --test all

# 4. Запуск отдельного теста
python chaos_monkey.py --test concurrent_config
```

## Альтернативный способ (Bash - требует WSL/Git Bash)

```bash
cd chaos_tests

# 1. Проверка окружения
bash diagnostic.sh

# 2. Запуск всех тестов
bash run_all_tests.sh
```

## Запуск отдельных тестов

### 1. Конкурентные обновления конфигурации
```bash
cd chaos_tests
bash test_concurrent_config.sh
```

### 2. Нормализация с невалидными данными
```bash
cd chaos_tests
bash test_invalid_normalization.sh
```

### 3. Устойчивость к сбоям AI
```bash
cd chaos_tests
bash test_ai_failure.sh
```

### 4. Работа с большими объемами
```bash
cd chaos_tests
bash test_large_data.sh
```

## Что проверяется

### test_concurrent_config.sh
- ✅ 10 параллельных обновлений конфигурации
- ✅ Ошибки блокировки БД
- ✅ Пропуски версий в истории
- ⏱️ Время выполнения: ~30 секунд

### test_invalid_normalization.sh
- ✅ Несуществующий database_id
- ✅ Невалидные параметры (item_id=0, пустой original_name)
- ✅ Невалидный JSON
- ⏱️ Время выполнения: ~20 секунд

### test_ai_failure.sh
- ✅ Невалидный API ключ
- ✅ Полный цикл нормализации
- ✅ Статус сессии после ошибки
- ⏱️ Время выполнения: ~60 секунд

### test_large_data.sh
- ✅ Мониторинг ресурсов (60+ секунд)
- ✅ Запуск нормализации с мониторингом
- ✅ Анализ CPU и памяти
- ⏱️ Время выполнения: ~5 минут

## Результаты

После выполнения тестов:

1. **Отчеты** находятся в `chaos_tests/reports/`
   - Каждый тест создает отдельный отчет
   - Сводный отчет создается при запуске `run_all_tests.sh`

2. **Логи** находятся в `chaos_tests/logs/`
   - Общий лог: `chaos_test_YYYYMMDD.log`
   - Ответы сервера сохраняются в отдельных файлах

3. **Просмотр результатов:**
   ```bash
   # Просмотр последнего отчета
   ls -t chaos_tests/reports/*.md | head -1 | xargs cat
   ```

## Требования

### Для Python-версии (рекомендуется):
```bash
python --version  # Должен быть 3.7+
pip install -r requirements.txt
```

### Для Bash-версии:
Убедитесь, что установлены:
- `curl` - для HTTP запросов
- `jq` - для парсинга JSON
- `bc` - для математических операций

Проверка:
```bash
curl --version
jq --version
bc --version
```

**Или просто запустите диагностический скрипт:**
```bash
bash diagnostic.sh
```

## Важные замечания

⚠️ **Внимание:**
- Тесты могут временно изменить конфигурацию сервера (автоматически восстанавливается)
- Некоторые тесты требуют наличия клиентов и проектов в БД
- Тест `test_large_data.sh` может занять до 5 минут

✅ **Безопасно:**
- Все изменения конфигурации автоматически откатываются
- Тесты не удаляют данные из БД
- Можно запускать на тестовом окружении

## Интерпретация результатов

### ✅ Успешно
- Нет ошибок блокировки БД
- Корректная обработка невалидных данных
- Сессии помечаются как failed при ошибках
- Нет утечек памяти

### ⚠️ Проблемы
- Ошибки "database is locked" → нужны транзакции
- Невалидные данные не обрабатываются → нужна валидация
- Сессии не помечаются как failed → нужна обработка ошибок
- Утечки памяти → нужна оптимизация

## Следующие шаги

1. Просмотрите отчеты в `chaos_tests/reports/`
2. Проверьте логи в `chaos_tests/logs/`
3. Исправьте найденные проблемы
4. Повторите тесты после исправлений

## Помощь

Подробная документация: `chaos_tests/README.md`

