# ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ–± —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

**–î–∞—Ç–∞:** 2025-11-21  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–£–ù–ò–§–ò–ö–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê**

---

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

### 1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ Normalizer.ProcessNormalization

**–§–∞–π–ª:** `normalization/normalizer.go`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `stopCheck func() bool` –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É `Normalizer`
- ‚úÖ –°–æ–∑–¥–∞–Ω –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä `NewNormalizerWithStopCheck` –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è normalizer —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `SetStopCheck` –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Ü–∏–∫–ª `ProcessNormalization` (–∫–∞–∂–¥—ã–µ 50 –∑–∞–ø–∏—Å–µ–π)

**–ö–æ–¥:**
```go
// –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–∞–∂–¥—ã–µ N –∑–∞–ø–∏—Å–µ–π
if i > 0 && i%stopCheckInterval == 0 && n.stopCheck != nil && n.stopCheck() {
    n.sendEvent(fmt.Sprintf("–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –Ω–∞ –∑–∞–ø–∏—Å–∏ %d –∏–∑ %d", i, len(items)))
    return fmt.Errorf("normalization stopped by user at item %d of %d", i, len(items))
}
```

---

### 2. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã Normalizer –≤ server.go

**–§–∞–π–ª:** `server/server.go`

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:
- ‚úÖ –í `handleNormalizeStart` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–¥–∞—á–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:
  - –î–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ normalizer: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `NewNormalizerWithStopCheck`
  - –î–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ normalizer: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SetStopCheck`

**–ö–æ–¥:**
```go
// –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
stopCheck := func() bool {
    s.normalizerMutex.RLock()
    shouldStop := !s.normalizerRunning
    s.normalizerMutex.RUnlock()
    return shouldStop
}

// –î–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ normalizer
normalizerToUse = normalization.NewNormalizerWithStopCheck(tempDB, s.normalizerEvents, aiConfig, stopCheck)

// –î–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ normalizer
normalizerToUse = s.normalizer
normalizerToUse.SetStopCheck(stopCheck)
```

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

### –¢–∏–ø—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:

1. ‚úÖ **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ (CounterpartyNormalizer)**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ 8 —Ç–æ—á–∫–∞—Ö
   - –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

2. ‚úÖ **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã (Normalizer)**
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Ü–∏–∫–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∫–∞–∂–¥—ã–µ 50 –∑–∞–ø–∏—Å–µ–π)
   - **–ù–û–í–û–ï - –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

3. ‚úÖ **–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ ClientNormalizer**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Å—Å–∏–∏ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
   - –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### –ï–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:

- ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π —Ñ–ª–∞–≥ `normalizerRunning`
- ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π –º—å—é—Ç–µ–∫—Å `normalizerMutex`
- ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤ —Ü–∏–∫–ª–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### API endpoints –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:

1. `/api/normalization/stop` - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã
2. `/api/clients/{id}/projects/{projectId}/normalization/stop` - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤

**–û–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π —Ñ–ª–∞–≥ `normalizerRunning`**

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –î–æ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- ‚ùå –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤ —Ü–∏–∫–ª–µ
- ‚ùå –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É
- ‚ö†Ô∏è –†–∞–∑–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

### –ü–æ—Å–ª–µ —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏:
- ‚úÖ –í—Å–µ —Ç–∏–ø—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤ —Ü–∏–∫–ª–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ï–¥–∏–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —á–µ—Ä–µ–∑ `normalizerRunning`
- ‚úÖ –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

---

## üîç –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ Normalizer:

**–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏:** –∫–∞–∂–¥—ã–µ 50 –∑–∞–ø–∏—Å–µ–π

**–ú–µ—Å—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:**
1. –í —Ü–∏–∫–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ items (—Å—Ç—Ä–æ–∫–∞ ~242)

**–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:**
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- –í–æ–∑–≤—Ä–∞—Ç –æ—à–∏–±–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ

---

## üìù –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã

1. `normalization/normalizer.go`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `stopCheck`
   - –°–æ–∑–¥–∞–Ω `NewNormalizerWithStopCheck`
   - –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `SetStopCheck`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ —Ü–∏–∫–ª

2. `server/server.go`
   - –û–±–Ω–æ–≤–ª–µ–Ω `handleNormalizeStart` –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ **–∑–∞–≤–µ—Ä—à–µ–Ω–∞**. –¢–µ–ø–µ—Ä—å:

- ‚úÖ –í—Å–µ —Ç–∏–ø—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞
- ‚úÖ –í—Å–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—ã–π —Ñ–ª–∞–≥ `normalizerRunning`
- ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤ —Ü–∏–∫–ª–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏
- ‚úÖ –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–í–°–ï –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–ò –ú–û–ñ–ù–û –û–°–¢–ê–ù–û–í–ò–¢–¨ –ò–ó –û–î–ù–û–ì–û –ú–ï–°–¢–ê**

