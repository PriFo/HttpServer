# Тестирование функциональности остановки нормализации контрагентов

## Обзор

Этот документ описывает тестовое покрытие для функциональности остановки нормализации контрагентов.

## Unit-тесты для CounterpartyNormalizer

Все unit-тесты находятся в файле `normalization/counterparty_normalizer_stop_test.go`.

### Созданные тесты

1. **TestProcessNormalization_StopCheck_BeforeDuplicates**
   - Проверяет остановку до анализа дублей
   - Ожидаемое поведение: 0 обработанных записей, анализ дублей не выполнен
   - Проверяет наличие сообщения об остановке в ошибках
   - Проверяет отправку события в канал

2. **TestProcessNormalization_StopCheck_AfterDuplicates**
   - Проверяет остановку после анализа дублей, но до начала обработки
   - Ожидаемое поведение: анализ дублей выполнен, но обработка не началась
   - Проверяет корректность сообщения об остановке

3. **TestProcessNormalization_StopCheck_FirstRecord**
   - Проверяет остановку на первой записи обработки
   - Ожидаемое поведение: 0 обработанных записей после начала цикла

4. **TestProcessNormalization_StopCheck_DuringProcessing**
   - Проверяет остановку во время обработки (примерно после 50 записей)
   - Ожидаемое поведение: обработано больше 0, но меньше общего количества
   - Проверяет сохранение частичных данных

5. **TestProcessNormalization_StopCheck_MidProcessing**
   - Проверяет остановку в середине обработки (после 75 записей)
   - Ожидаемое поведение: обработано больше 50, но меньше общего количества

6. **TestProcessNormalization_StopCheck_NoStop**
   - Проверяет нормальную работу без остановки
   - Ожидаемое поведение: все записи обработаны, нет ошибок об остановке

7. **TestProcessNormalization_StopCheck_NilStopCheck**
   - Проверяет работу с nil stopCheck
   - Ожидаемое поведение: все записи обработаны, нет ошибок об остановке

8. **TestProcessNormalization_StopCheck_PartialDataPreservation**
   - Проверяет сохранение частичных данных при остановке
   - Ожидаемое поведение: частично обработанные данные сохранены в БД

## Запуск тестов

### Запуск всех тестов остановки:
```bash
go test -v ./normalization -run TestProcessNormalization_StopCheck
```

### Запуск конкретного теста:
```bash
go test -v ./normalization -run TestProcessNormalization_StopCheck_BeforeDuplicates
```

## Покрытие точек остановки

Тесты покрывают следующие точки остановки:

- ✅ Перед анализом дублей
- ✅ После анализа дублей, перед началом обработки
- ✅ В начале цикла обработки (первая запись)
- ✅ Во время обработки (каждые 50 записей)
- ✅ В середине обработки (после 75 записей)

## Проверяемые аспекты

Каждый тест проверяет:

1. **Корректность количества обработанных записей**
   - При остановке должно быть обработано правильное количество записей

2. **Наличие сообщения об остановке**
   - В `result.Errors` должно быть сообщение "Нормализация остановлена пользователем"

3. **Отправка событий**
   - События об остановке должны отправляться в канал событий

4. **Сохранение частичных данных**
   - Частично обработанные данные должны сохраняться в БД

## Следующие шаги

### Интеграционные тесты (требуется создание)

1. **Тест processCounterpartyDatabase с остановкой**
   - Проверка обновления сессии нормализации
   - Проверка установки finishedAt
   - Проверка статуса "stopped"

2. **Тест handleStopClientNormalization**
   - Проверка установки флага normalizerRunning в false
   - Проверка остановки всех активных сессий
   - Проверка HTTP ответа

3. **Тест processCounterpartyDatabasesParallel**
   - Проверка остановки всех параллельных воркеров
   - Проверка финального статуса после завершения

### End-to-end тесты (требуется создание)

1. **Полный цикл нормализации с остановкой**
   - Запуск нормализации
   - Остановка через API
   - Проверка статуса сессии
   - Проверка сохранения частичных данных

2. **Тест дашборда**
   - Проверка отображения статуса остановки
   - Проверка визуальных индикаторов
   - Проверка информационных сообщений

## Метрики для проверки

### Покрытие точек остановки:
- ✅ before duplicate analysis
- ✅ after duplicate analysis
- ✅ before processing counterparts
- ✅ every 50 records during processing
- ✅ after processing batch

### Проверка корректности данных:
- ✅ processed_count accurately reflects stopped state
- ✅ duplicates_analysis_done flag is correct (неявно через проверку DuplicateGroups)
- ✅ error message indicates user stop
- ✅ events are sent to channel
- ⏳ session status is 'stopped' (требуется интеграционный тест)
- ⏳ finished_at timestamp is set (требуется интеграционный тест)
- ⏳ progress percentage is calculated (требуется интеграционный тест)

## Рекомендации

1. **Мониторинг остановок**
   - Добавить метрики для отслеживания частоты остановок
   - Логировать причины остановки

2. **Валидация частичных данных**
   - Проверка целостности при перезапуске
   - Возможность продолжения нормализации с места остановки

3. **Оптимизация производительности**
   - Использовать atomic load для минимизации блокировок
   - Оптимизировать частоту проверок остановки

## Заключение

Unit-тесты для функциональности остановки созданы и покрывают основные сценарии. Для полного покрытия требуется создание интеграционных и end-to-end тестов.

