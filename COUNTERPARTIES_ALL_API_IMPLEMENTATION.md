# Реализация API получения всех контрагентов клиента

## Дата реализации
2025-01-XX

## Описание
Реализован новый API endpoint для получения всех контрагентов клиента из всех баз данных по всем проектам, включая как исходные (ненормализованные) контрагенты из баз данных, так и нормализованные из таблицы `normalized_counterparties`.

## Обновление 2025-11-27: потоковая выдача и очередь экспорта
- Добавлен менеджер тяжелых выгрузок, ограничивающий число параллельных запросов с лимитом ≥ 5 000 записей. При превышении лимита возвращается `429 Too Many Requests`.
- Поддерживается параметр `load_all=1`, который включает потоковую выдачу до `100 000` записей (JSON формируется по частям, сервер сразу возвращает тело в режиме chunked).
- Ответ теперь содержит флаг `limit_clamped`, если запрошенный лимит был обрезан до максимума.
- Таймаут записи HTTP-сервера увеличен до `5m`, а ответы автоматически сжимаются GZIP-мидлварью.
- Фронтенд использует новый UI с прогресс-баром и предупреждением о том, что тяжелые выгрузки занимают до нескольких минут.

## Измененные файлы

### 1. `database/service_db.go`

#### Добавлена структура `UnifiedCounterparty`
```go
type UnifiedCounterparty struct {
    ID              int     `json:"id"`
    Name            string  `json:"name"`
    Source          string  `json:"source"` // "database" или "normalized"
    ProjectID       int     `json:"project_id"`
    ProjectName     string  `json:"project_name"`
    DatabaseID      *int    `json:"database_id,omitempty"`
    DatabaseName    string  `json:"database_name,omitempty"`
    // ... другие поля
}
```

#### Добавлен метод `GetAllCounterpartiesByClient`
- Получает все проекты клиента (или конкретный проект)
- Для каждого проекта получает все активные базы данных
- Извлекает контрагентов из исходных баз через `GetCatalogItemsByUpload`
- Получает нормализованных контрагентов через `GetNormalizedCounterpartiesByClient`
- Объединяет оба списка с указанием источника
- Поддерживает фильтрацию по источнику, поиск и пагинацию

#### Добавлены вспомогательные методы
- `catalogItemToUnified` - преобразует `CatalogItem` в `UnifiedCounterparty`
- `normalizedToUnified` - преобразует `NormalizedCounterparty` в `UnifiedCounterparty`
- `matchesSearch` - проверяет соответствие контрагента поисковому запросу

#### Добавлен импорт
```go
import "httpserver/extractors"
```

### 2. `server/server.go`

#### Зарегистрирован маршрут
```go
mux.HandleFunc("/api/counterparties/all", s.handleGetAllCounterparties)
```

#### Реализован handler `handleGetAllCounterparties`
- Валидация параметров запроса
- Поддержка параметров: `client_id`, `project_id`, `search`, `source`, `offset`, `limit`
- Обработка ошибок
- Формирование JSON ответа

## Новые файлы

### 1. `test_counterparties_all_api.ps1`
PowerShell скрипт для тестирования API с 7 тестовыми сценариями:
- Получение всех контрагентов клиента
- Пагинация
- Фильтр по источнику (database)
- Фильтр по источнику (normalized)
- Поиск по имени
- Фильтр по проекту
- Валидация ошибок

### 2. `api_tests/test_counterparties_all_api.html`
Интерактивный HTML интерфейс для тестирования API с описанием всех параметров и примерами запросов.

### 3. `api_tests/COUNTERPARTIES_ALL_API.md`
Полная документация API с примерами использования, форматом ответа и описанием всех параметров.

## API Endpoint

### URL
```
GET /api/counterparties/all
```

### Параметры запроса

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `client_id` | integer | Да | ID клиента |
| `project_id` | integer | Нет | ID проекта (для фильтрации) |
| `search` | string | Нет | Поиск по имени, ИНН, БИН |
| `source` | string | Нет | Фильтр: "database", "normalized" или пусто (все) |
| `offset` | integer | Нет | Смещение для пагинации (по умолчанию: 0) |
| `limit` | integer | Нет | Количество записей (по умолчанию: 100, максимум: 1000) |

### Пример запроса
```bash
curl -X GET "http://localhost:9999/api/counterparties/all?client_id=1&source=database&limit=10"
```

### Формат ответа
```json
{
  "counterparties": [
    {
      "id": 1,
      "name": "ООО Пример",
      "source": "database",
      "project_id": 1,
      "project_name": "Проект 1",
      "database_id": 1,
      "database_name": "База данных 1",
      "tax_id": "1234567890",
      ...
    }
  ],
  "projects": [...],
  "total": 100,
  "offset": 0,
  "limit": 10
}
```

## Особенности реализации

1. **Объединение данных из двух источников**:
   - Исходные базы данных (через `GetCatalogItemsByUpload`)
   - Нормализованные записи (из таблицы `normalized_counterparties`)

2. **Извлечение данных из XML-атрибутов**:
   - Используются функции из пакета `extractors`
   - Извлекаются: ИНН, КПП, БИН, адреса, контакты

3. **Обработка ошибок**:
   - Недоступные базы данных пропускаются с логированием
   - Базы данных закрываются сразу после использования
   - Ошибки не прерывают выполнение для других баз

4. **Сортировка**:
   - Объединенный список сортируется по наличию `quality_score` (нормализованные выше)
   - Затем по значению `quality_score` (выше качество - выше в списке)
   - Затем по имени (без учета регистра, алфавитный порядок)
   - В конце по ID (для стабильности сортировки)

5. **Пагинация**:
   - Применяется после объединения и сортировки всех контрагентов
   - Общее количество (`total`) включает все записи из обоих источников

5. **Фильтрация**:
   - По источнику данных (`source`)
   - По проекту (`project_id`)
   - Поиск по имени, ИНН, БИН (`search`)

## Тестирование

### PowerShell скрипт
```powershell
.\test_counterparties_all_api.ps1 [client_id] [base_url]
```

### HTML интерфейс
Откройте `api_tests/test_counterparties_all_api.html` в браузере

## Проверка компиляции
✅ Код успешно компилируется без ошибок

## Статус
✅ Реализация завершена и готова к использованию

