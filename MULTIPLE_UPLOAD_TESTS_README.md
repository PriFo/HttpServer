# Тестирование множественной загрузки баз данных

## Обзор

Комплексный набор тестов для проверки функциональности множественной загрузки баз данных по клиенту. Тесты покрывают unit-тесты, интеграционные тесты, E2E тесты, нагрузочные тесты и тесты граничных случаев.

## Структура тестов

### 1. Unit-тесты (Backend)
**Файл:** `server/database_upload_multiple_test.go`

**Запуск:**
```bash
go test ./server -run TestMultipleUpload -v
```

**Покрытие:**
- Последовательная загрузка нескольких файлов
- Обработка ошибок при частичной загрузке
- Валидация каждого файла
- Ограничения размера файла
- Переименование файлов с одинаковыми именами
- Очистка при частичной ошибке
- Большие файлы и стресс-тесты

### 2. Интеграционные тесты (API)
**Файл:** `test_multiple_database_upload.ps1`

**Запуск:**
```powershell
.\test_multiple_database_upload.ps1
```

**Проверяет:**
- Последовательную загрузку 3 файлов
- Файлы разных размеров
- Смешанные файлы (валидные и невалидные)
- Дублирующиеся имена
- Метрики загрузки
- Большую партию файлов

### 3. E2E тесты (Frontend)
**Файл:** `test_multiple_upload_e2e.ps1`

**Запуск:**
```powershell
.\test_multiple_upload_e2e.ps1
```

**Требования:**
- Backend должен быть запущен на `http://localhost:9999`
- Frontend должен быть запущен на `http://localhost:3000` (опционально)

**Проверяет:**
- Доступность серверов
- Множественную загрузку через Frontend API
- Отслеживание прогресса
- Обработку ошибок в UI
- Смешанные типы файлов

### 4. Нагрузочные тесты
**Файл:** `test_multiple_upload_load.ps1`

**Запуск:**
```powershell
.\test_multiple_upload_load.ps1
```

**Проверяет:**
- Загрузку 15 файлов подряд
- Большие файлы (50MB, 100MB, 200MB)
- Смешанную партию разных размеров
- Производительность и скорость загрузки

### 5. Тесты граничных случаев
**Файл:** `test_multiple_upload_edge_cases.ps1`

**Запуск:**
```powershell
.\test_multiple_upload_edge_cases.ps1
```

**Проверяет:**
- Специальные символы в именах файлов
- Очень длинные имена файлов
- Смешанные типы файлов
- Дублирующиеся имена
- Пустые и минимальные файлы
- Защиту от path traversal
- Unicode символы в именах

## Быстрый старт

### Предварительные требования

1. **Backend сервер должен быть запущен:**
   ```bash
   go run main.go
   # или
   .\start-server.ps1
   ```

2. **Для E2E тестов (опционально) - Frontend должен быть запущен:**
   ```bash
   cd frontend
   npm run dev
   ```

### Запуск всех тестов

```powershell
# 1. Unit-тесты
go test ./server -run TestMultipleUpload -v

# 2. Интеграционные тесты
.\test_multiple_database_upload.ps1

# 3. E2E тесты
.\test_multiple_upload_e2e.ps1

# 4. Нагрузочные тесты
.\test_multiple_upload_load.ps1

# 5. Тесты граничных случаев
.\test_multiple_upload_edge_cases.ps1
```

## Результаты тестов

### HTML отчет
После выполнения тестов можно открыть HTML отчет:
```
api_tests/multiple_upload_test_report.html
```

Отчет содержит:
- Общую сводку по всем тестам
- Детальные результаты каждого теста
- Метрики производительности
- Выводы и рекомендации

## API Endpoint

Все тесты используют следующий endpoint:

```
POST /api/clients/{clientId}/projects/{projectId}/databases
Content-Type: multipart/form-data

Параметры:
- file: файл базы данных (.db)
- auto_create: "true" для автоматического создания записи в БД
- description: описание базы данных (опционально)
```

## Ожидаемое поведение

### Успешная загрузка
- HTTP статус: `201 Created` (при `auto_create=true`) или `200 OK`
- Ответ содержит:
  ```json
  {
    "success": true,
    "database": { ... },
    "file_path": "...",
    "file_name": "...",
    "upload_metrics": {
      "duration_sec": ...,
      "speed_mbps": ...,
      "file_size_mb": ...
    }
  }
  ```

### Ошибка валидации
- HTTP статус: `400 Bad Request`
- Ответ содержит описание ошибки

## Метрики производительности

Типичные показатели:
- **Маленькие файлы (< 1MB):** < 1 секунда на файл
- **Средние файлы (1-10MB):** 1-5 секунд на файл
- **Большие файлы (10-100MB):** зависит от скорости сети
- **Очень большие файлы (100-500MB):** зависит от скорости сети

## Известные ограничения

1. **Максимальный размер файла:** 500MB
2. **Максимальная длина имени файла:** 255 символов
3. **Поддерживаемые форматы:** только `.db` (SQLite)
4. **Загрузка:** последовательная (не параллельная)

## Рекомендации

1. **Для продакшена:**
   - Рассмотреть возможность параллельной загрузки
   - Добавить прогресс-бар для множественной загрузки
   - Улучшить обработку сетевых ошибок

2. **Для разработки:**
   - Запускать unit-тесты перед коммитом
   - Использовать интеграционные тесты для проверки API
   - E2E тесты для проверки полного flow

## Устранение неполадок

### Backend не отвечает
```powershell
# Проверить, запущен ли сервер
Test-NetConnection -ComputerName localhost -Port 9999

# Запустить сервер
.\start-server.ps1
```

### Frontend не отвечает
```powershell
# Проверить, запущен ли frontend
Test-NetConnection -ComputerName localhost -Port 3000

# Запустить frontend
cd frontend
npm run dev
```

### Ошибки при создании тестовых файлов
- Убедитесь, что есть права на запись в временную директорию
- Проверьте доступное место на диске

## Дополнительная информация

- **План тестирования:** `.plan.md`
- **HTML отчет:** `api_tests/multiple_upload_test_report.html`
- **Существующие тесты:** `server/database_upload_test.go`

