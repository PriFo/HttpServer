# Бенчмарк бесплатных моделей OpenRouter

## Описание

Бенчмарк для тестирования производительности бесплатных моделей OpenRouter API. Автоматически фильтрует модели с окончанием "free" и тестирует их на классификации товаров.

## Возможности

✅ **Автоматическая фильтрация** - тестирует только бесплатные модели (окончание "free")  
✅ **Retry логика** - автоматические повторные попытки при ошибках  
✅ **Параллельное выполнение** - настраиваемое количество параллельных запросов  
✅ **Промежуточные результаты** - автоматическое сохранение прогресса  
✅ **Гибкая конфигурация** - множество параметров командной строки  
✅ **Загрузка тестовых данных** - из файла или встроенные данные  

## Использование

### Базовое использование

```bash
# Тестировать все бесплатные модели
go run test_openrouter_models_benchmark.go

# Или использовать скомпилированный файл
.\test_openrouter_models_benchmark.exe
```

### Параметры командной строки

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `-server` | URL сервера | `http://localhost:9999` |
| `-models` | Список моделей через запятую | все бесплатные |
| `-retries` | Количество повторных попыток | `3` |
| `-timeout` | Таймаут запроса (секунды) | `30` |
| `-parallel` | Параллельные запросы (0 = без ограничений) | `0` |
| `-save-progress` | Сохранять промежуточные результаты | `true` |
| `-test-products` | Файл с тестовыми продуктами | встроенные |

### Примеры

```bash
# Тестировать только выбранные модели
.\test_openrouter_models_benchmark.exe -models "meta-llama/llama-3.2-3b-instruct:free,mistralai/mistral-7b-instruct:free"

# Использовать другой сервер
.\test_openrouter_models_benchmark.exe -server "http://localhost:8080"

# Увеличить количество повторных попыток и таймаут
.\test_openrouter_models_benchmark.exe -retries 5 -timeout 60

# Ограничить параллелизм (максимум 5 одновременных запросов)
.\test_openrouter_models_benchmark.exe -parallel 5

# Использовать свои тестовые данные
.\test_openrouter_models_benchmark.exe -test-products "my_products.txt"

# Отключить сохранение промежуточных результатов
.\test_openrouter_models_benchmark.exe -save-progress=false
```

### Формат файла с тестовыми продуктами

Создайте текстовый файл, где каждый продукт на отдельной строке. Строки, начинающиеся с `#`, считаются комментариями:

```
# Тестовые продукты для бенчмарка
Болт М8х20
Гайка М8
Шайба плоская М8
# Еще один продукт
Винт саморез 4.2х16
```

## Результаты

Бенчмарк генерирует два типа отчетов:

### JSON отчет
`openrouter_models_benchmark_YYYYMMDD_HHMMSS.json`

Содержит детальную статистику по каждой модели:
- Скорость (запросов/сек)
- Среднее, медианное, минимальное, максимальное время ответа
- 95-й перцентиль времени ответа
- Количество успешных/неуспешных запросов
- Процент успешности

### HTML отчет
`openrouter_models_benchmark_YYYYMMDD_HHMMSS.html`

Визуальный отчет с таблицей результатов, графиками и рекомендациями.

### Промежуточные результаты
`openrouter_models_benchmark_progress_X_of_Y_YYYYMMDD_HHMMSS.json`

Сохраняются автоматически каждые 5 моделей (если включено `-save-progress`).

## Статистика моделей

По состоянию на 2025-11-21:
- **Всего моделей в OpenRouter**: 339
- **Бесплатных моделей**: 41 (12.1%)

## Требования

1. **Запущенный сервер** - сервер должен быть доступен по указанному URL
2. **Настроенный провайдер OpenRouter** - в конфигурации сервера должен быть настроен провайдер OpenRouter
3. **API ключ** - `OPENROUTER_API_KEY` должен быть установлен в переменных окружения или в конфигурации сервера

## Улучшения

### Retry логика
- Автоматические повторные попытки при сетевых ошибках
- Экспоненциальная задержка между попытками (200ms, 400ms, 800ms...)
- Повтор только для серверных ошибок (5xx), клиентские ошибки (4xx) не повторяются

### Параллельное выполнение
- Все запросы для одной модели выполняются параллельно
- Настраиваемое ограничение параллелизма через `-parallel`
- Потокобезопасная статистика

### Обработка ошибок
- Детальное логирование ошибок
- Разделение на сетевые, серверные и клиентские ошибки
- Продолжение работы при ошибках отдельных запросов

## Рекомендации

1. **Для быстрого теста**: используйте `-models` для выбора 2-3 моделей
2. **Для полного теста**: запустите без параметров для тестирования всех 41 бесплатной модели
3. **При проблемах с сетью**: увеличьте `-retries` и `-timeout`
4. **При ограничениях API**: используйте `-parallel` для ограничения нагрузки

## Примеры результатов

После завершения бенчмарка вы получите:
- Ранжированный список моделей по скорости
- Рекомендации по выбору модели
- Детальную статистику по каждой модели
- Визуальные отчеты для анализа

## Поддержка

При возникновении проблем:
1. Проверьте, что сервер запущен и доступен
2. Убедитесь, что провайдер OpenRouter настроен в конфигурации
3. Проверьте наличие `OPENROUTER_API_KEY`
4. Увеличьте таймауты при медленном соединении

