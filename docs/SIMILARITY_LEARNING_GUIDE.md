# Руководство по обучению алгоритмов схожести

## Обзор

Система обучения позволяет оптимизировать веса алгоритмов схожести на основе размеченных данных. Это повышает точность обнаружения дублей для конкретных типов данных.

## Основные концепции

### 1. Обучение на размеченных данных

Алгоритм использует градиентный спуск для минимизации ошибки классификации. Веса каждого алгоритма (Jaro-Winkler, LCS, Phonetic, N-gram, Jaccard) оптимизируются на основе обучающих пар.

### 2. Кросс-валидация

Кросс-валидация позволяет оценить качество алгоритма на разных подмножествах данных, что помогает избежать переобучения.

### 3. Оптимальный порог

Система автоматически находит оптимальный порог схожести, который максимизирует F1-score.

## Процесс обучения

### Шаг 1: Подготовка данных

Создайте набор размеченных пар строк:

```json
{
  "training_pairs": [
    {
      "s1": "ООО Рога и Копыта",
      "s2": "ООО Рога и Копыта",
      "is_duplicate": true
    },
    {
      "s1": "ООО Рога и Копыта",
      "s2": "Рога и Копыта ООО",
      "is_duplicate": true
    },
    {
      "s1": "ООО Рога и Копыта",
      "s2": "ООО Другая Компания",
      "is_duplicate": false
    }
  ]
}
```

### Шаг 2: Обучение

Отправьте запрос на обучение:

```bash
curl -X POST http://localhost:9999/api/similarity/learn \
  -H "Content-Type: application/json" \
  -d '{
    "training_pairs": [...],
    "iterations": 100,
    "learning_rate": 0.01
  }'
```

### Шаг 3: Оценка качества

Проверьте метрики на тестовых данных:

```bash
curl -X POST http://localhost:9999/api/similarity/evaluate \
  -H "Content-Type: application/json" \
  -d '{
    "test_pairs": [...],
    "threshold": 0.75,
    "weights": {...}
  }'
```

### Шаг 4: Кросс-валидация

Выполните кросс-валидацию для оценки надежности:

```bash
curl -X POST http://localhost:9999/api/similarity/cross-validate \
  -H "Content-Type: application/json" \
  -d '{
    "training_pairs": [...],
    "folds": 5
  }'
```

## Рекомендации

### Размер обучающей выборки

- **Минимум**: 50 пар для базовой оптимизации
- **Рекомендуется**: 200-500 пар для хорошего качества
- **Оптимально**: 1000+ пар для максимальной точности

### Баланс данных

Обучающая выборка должна содержать:
- **50-60%** положительных примеров (дубликаты)
- **40-50%** отрицательных примеров (не дубликаты)

### Параметры обучения

- **iterations**: 50-200 (больше итераций = лучше оптимизация, но дольше)
- **learning_rate**: 0.001-0.1 (меньше = стабильнее, но медленнее)

### Кросс-валидация

- Используйте 5-10 фолдов
- Убедитесь, что в каждом фолде есть и положительные, и отрицательные примеры

## Примеры использования

### Пример 1: Обучение на данных контрагентов

```javascript
const trainingPairs = [
  { s1: "ООО Рога и Копыта", s2: "ООО Рога и Копыта", is_duplicate: true },
  { s1: "ООО Рога и Копыта", s2: "Рога и Копыта ООО", is_duplicate: true },
  { s1: "ООО Рога и Копыта", s2: "ООО Другая Компания", is_duplicate: false },
  // ... больше примеров
];

const response = await fetch('http://localhost:9999/api/similarity/learn', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    training_pairs: trainingPairs,
    iterations: 100,
    learning_rate: 0.01
  })
});

const result = await response.json();
console.log('Optimized weights:', result.weights);
console.log('Metrics:', result.metrics);
```

### Пример 2: Поиск оптимального порога

```javascript
const testPairs = [
  { s1: "Кабель ВВГнг", s2: "Кабель ВВГ", is_duplicate: true },
  { s1: "Кабель ВВГнг", s2: "Провод ПВС", is_duplicate: false },
  // ... больше примеров
];

const response = await fetch('http://localhost:9999/api/similarity/optimal-threshold', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    test_pairs: testPairs,
    weights: {
      jaro_winkler: 0.3,
      lcs: 0.2,
      phonetic: 0.2,
      ngram: 0.2,
      jaccard: 0.1
    }
  })
});

const result = await response.json();
console.log('Optimal threshold:', result.optimal_threshold);
console.log('F1-score:', result.metrics.f1_score);
```

## Интерпретация результатов

### Метрики качества

- **Precision > 0.90**: Высокая точность, мало ложных срабатываний
- **Recall > 0.85**: Хорошая полнота, мало пропущенных дублей
- **F1-score > 0.90**: Сбалансированная производительность
- **False Positive Rate < 0.10**: Ошибки первого рода в норме
- **False Negative Rate < 0.05**: Ошибки второго рода в норме

### Веса алгоритмов

После обучения веса показывают, какие алгоритмы наиболее важны для ваших данных:

- **Высокий вес Jaro-Winkler**: Много опечаток и перестановок
- **Высокий вес Phonetic**: Много похожих по звучанию слов
- **Высокий вес N-gram**: Много частичных совпадений
- **Высокий вес LCS**: Много общих подпоследовательностей

## Устранение проблем

### Низкая точность (Precision < 0.80)

- Увеличьте порог схожести
- Добавьте больше отрицательных примеров в обучающую выборку
- Уменьшите вес алгоритмов, дающих много ложных срабатываний

### Низкая полнота (Recall < 0.80)

- Снизьте порог схожести
- Добавьте больше положительных примеров
- Увеличьте вес алгоритмов, которые хорошо находят дубликаты

### Переобучение

- Используйте кросс-валидацию для проверки
- Уменьшите количество итераций
- Увеличьте размер обучающей выборки

## См. также

- [SIMILARITY_API.md](./SIMILARITY_API.md) - Полная документация API
- [ADVANCED_SIMILARITY_README.md](../normalization/algorithms/ADVANCED_SIMILARITY_README.md) - Детали реализации

