# Server Stability Fixes

Этот документ описывает исправления критических ошибок и предупреждений, обнаруженных при запуске сервера.

## 1. Критическая ошибка: Отсутствие таблицы providers

### Проблема
При запуске сервера возникала ошибка:
```
Warning: Failed to get providers from DB: failed to get active providers: no such table: providers. 
Multi-provider client will not be initialized.
```

Это означало, что критически важный компонент системы (мульти-провайдерный клиент) не мог инициализироваться из-за отсутствия таблицы в сервисной базе данных.

### Решение
Таблица `providers` теперь автоматически создается при инициализации сервисной базы данных в функции `InitServiceSchema()` в файле `database/schema.go`.

**Структура таблицы:**
- `id` (TEXT PRIMARY KEY) - уникальный идентификатор провайдера
- `name` (TEXT NOT NULL UNIQUE) - название провайдера
- `api_key` (TEXT) - API ключ для доступа к провайдеру
- `base_url` (TEXT) - базовый URL провайдера
- `enabled` (BOOLEAN DEFAULT TRUE) - флаг активности провайдера
- `priority` (INTEGER DEFAULT 0) - приоритет провайдера (для оркестратора)
- `channels` (INTEGER DEFAULT 1) - количество параллельных каналов
- `created_at` (TIMESTAMP DEFAULT CURRENT_TIMESTAMP)
- `updated_at` (TIMESTAMP DEFAULT CURRENT_TIMESTAMP)

**Индексы:**
- `idx_providers_enabled` - для быстрого поиска активных провайдеров
- `idx_providers_priority` - для сортировки по приоритету

**Дефолтные провайдеры:**
При создании таблицы автоматически добавляются следующие провайдеры (по умолчанию disabled):
- OpenRouter
- Hugging Face
- Arliai (2 канала)
- Eden AI

Также автоматически добавляются провайдеры для стандартизации данных:
- DaData.ru
- Adata.kz

### Важность
Без таблицы `providers` система не может использовать мульти-провайдерную архитектуру для нормализации данных, что критически снижает функциональность и отказоустойчивость системы.

---

## 2. Предупреждение: Некорректная иерархия в классификаторе КПВЭД

### Проблема
В логах появлялись множественные сообщения:
```
Info: Using nearest parent 30 for node 30.92.1 (requested parent 30.92 not found)
```

Это указывает на то, что в данных классификатора КПВЭД некоторые узлы ссылаются на несуществующих родителей. Система подставляет ближайшего существующего родителя, что может привести к неверной классификации.

### Решение
Создан файл `database/kpved_diagnostics.sql` с диагностическими запросами и вариантами исправления:

1. **Диагностика:** Запросы для выявления всех "осиротевших" узлов
2. **Решение 1:** Обновление `parent_code` на ближайшего существующего родителя
3. **Решение 2:** Установка `parent_code = NULL` для узлов без существующего родителя
4. **Решение 3:** Создание недостающих родительских узлов (требует ручного заполнения названий)

### Использование
1. Выполните диагностические запросы из `database/kpved_diagnostics.sql`
2. Проанализируйте результаты
3. Выберите подходящий вариант исправления
4. Выполните запросы исправления (после ручной проверки!)
5. Проверьте целостность с помощью валидационного запроса

### Важность
Некорректная иерархия может привести к неправильной классификации товаров и услуг, что влияет на качество нормализации данных и последующий анализ.

---

## 3. Предупреждение GIN: Работа в "debug" режиме

### Проблема
При запуске сервера появлялось предупреждение:
```
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
```

Режим отладки небезопасен и менее производителен для продакшена.

### Решение

#### Вариант 1: Через переменную окружения (рекомендуется)
Установите переменную окружения перед запуском:
```bash
# Linux/macOS
export GIN_MODE=release
./httpserver

# Windows (PowerShell)
$env:GIN_MODE="release"
.\httpserver.exe

# Windows (CMD)
set GIN_MODE=release
httpserver.exe
```

#### Вариант 2: Через код (уже реализовано)
В файле `server/server_start_shutdown.go` добавлена автоматическая установка режима release, если переменная окружения `GIN_MODE` не установлена:

```go
// Устанавливаем режим Gin: release для продакшена, debug для разработки
// Можно переопределить через переменную окружения GIN_MODE
if ginMode := os.Getenv("GIN_MODE"); ginMode == "" {
    gin.SetMode(gin.ReleaseMode)
}
```

Это означает, что по умолчанию сервер запускается в режиме release, но можно переопределить через переменную окружения для разработки.

### Важность
- **Безопасность:** Режим debug выводит подробную информацию об ошибках, что может раскрыть внутреннюю структуру приложения
- **Производительность:** Режим release оптимизирован для продакшена и работает быстрее
- **Логирование:** В режиме release логи более структурированы и менее подробны

---

## Резюме

Все три проблемы были исправлены:

1. ✅ **Таблица providers** - автоматически создается при инициализации сервисной БД
2. ✅ **Иерархия КПВЭД** - предоставлены диагностические запросы и варианты исправления
3. ✅ **Gin режим** - автоматически устанавливается в release, с возможностью переопределения через `GIN_MODE`

Эти исправления обеспечивают стабильную и безопасную работу сервера в продакшене.

