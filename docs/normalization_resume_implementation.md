# Механизм возобновления нормализации контрагентов

## Обзор

Механизм возобновления позволяет продолжить нормализацию контрагентов с того места, где она была остановлена. При возобновлении система автоматически пропускает уже обработанные контрагенты и продолжает нормализацию только для оставшихся.

## Как это работает

### 1. Отслеживание обработанных контрагентов

Система использует поле `source_reference` из таблицы `normalized_counterparties` для определения, какие контрагенты уже были нормализованы. При возобновлении:

1. Получается список всех контрагентов из базы данных
2. Запрашиваются уже нормализованные контрагенты по `source_reference` для проекта
3. Фильтруются уже обработанные контрагенты
4. Нормализация продолжается только для оставшихся

### 2. API Endpoint

**POST** `/api/clients/{clientId}/projects/{projectId}/normalization/sessions/{sessionId}/resume`

Возобновляет остановленную сессию нормализации.

**Параметры:**
- `clientId` - ID клиента
- `projectId` - ID проекта
- `sessionId` - ID остановленной сессии

**Ответ:**
```json
{
  "success": true,
  "session_id": 123,
  "message": "Normalization resumed"
}
```

**Ошибки:**
- `404` - Сессия не найдена
- `400` - Сессия не остановлена (статус не "stopped")
- `403` - Сессия не принадлежит проекту

### 3. Процесс возобновления

1. **Проверка сессии:**
   - Проверяется, что сессия существует и принадлежит проекту
   - Проверяется, что статус сессии "stopped"

2. **Возобновление сессии:**
   - Статус сессии изменяется с "stopped" на "running"
   - `finished_at` устанавливается в `NULL`

3. **Запуск нормализации:**
   - Запускается в отдельной горутине
   - Получаются все контрагенты из базы данных
   - Фильтруются уже нормализованные контрагенты
   - Нормализация продолжается только для оставшихся

4. **Завершение:**
   - При успешном завершении статус меняется на "completed"
   - При остановке статус меняется на "stopped"
   - При ошибке статус меняется на "failed"

## Использование

### Пример запроса

```bash
curl -X POST http://localhost:9999/api/clients/1/projects/1/normalization/sessions/123/resume
```

### Пример ответа

```json
{
  "success": true,
  "session_id": 123,
  "message": "Normalization resumed"
}
```

## Технические детали

### Методы базы данных

1. **GetNormalizedCounterpartiesBySourceReferences** - получает список уже нормализованных контрагентов по `source_reference`
2. **ResumeNormalizationSession** - возобновляет остановленную сессию

### Изменения в CounterpartyNormalizer

Метод `ProcessNormalization` теперь принимает параметр `skipNormalized`:
- `false` - обрабатывает все контрагенты (новая сессия)
- `true` - пропускает уже нормализованных (возобновление)

### Логика фильтрации

```go
// Получаем уже нормализованных контрагентов
normalizedRefs, err := serviceDB.GetNormalizedCounterpartiesBySourceReferences(projectID, sourceReferences)

// Фильтруем уже нормализованных
filtered := make([]*database.CatalogItem, 0, len(counterparties))
for _, item := range counterparties {
    if item.Reference == "" || !normalizedRefs[item.Reference] {
        filtered = append(filtered, item)
    }
}
counterparties = filtered
```

## Преимущества

1. **Эффективность:** Не обрабатывает уже нормализованных контрагентов
2. **Надежность:** Сохраняет прогресс при остановке
3. **Гибкость:** Можно возобновить в любое время
4. **Прозрачность:** Логирует количество пропущенных контрагентов

## Ограничения

1. Возобновление возможно только для сессий со статусом "stopped"
2. Контрагенты должны иметь уникальный `source_reference`
3. Возобновление работает только для контрагентов (не для номенклатуры)

## Примеры использования

### Возобновление остановленной сессии

```bash
# Остановить сессию
curl -X POST http://localhost:9999/api/clients/1/projects/1/normalization/sessions/123/stop

# Возобновить сессию
curl -X POST http://localhost:9999/api/clients/1/projects/1/normalization/sessions/123/resume
```

### Проверка статуса

```bash
# Получить список сессий
curl http://localhost:9999/api/clients/1/projects/1/normalization/sessions
```

## Логирование

При возобновлении система логирует:
- Количество пропущенных уже нормализованных контрагентов
- Количество контрагентов для обработки
- Прогресс нормализации
- Результаты обработки

Пример лога:
```
[Counterparty] [ClientID:1] [ProjectID:1] Пропущено уже нормализованных: 50
[Counterparty] [ClientID:1] [ProjectID:1] Начало нормализации: 100 записей (из 150 исходных)
```

