# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—É—Ç–µ–π –≤ API

## üìã –û–±–∑–æ—Ä

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ 500 (Internal Server Error) –≤ API —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞—Ö, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –ø—É—Ç–µ–π –∫ –±–∞–∑–∞–º –¥–∞–Ω–Ω—ã—Ö.

## üêõ –ü—Ä–æ–±–ª–µ–º—ã

### 1. –û—à–∏–±–∫–∞ 500 –≤ `/api/databases/find-project`
- **–°–∏–º–ø—Ç–æ–º—ã:** HTTP 500 –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ –ø—É—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- **–ü—Ä–∏—á–∏–Ω–∞:** 
  - –ü—É—Ç—å –ø—Ä–∏—Ö–æ–¥–∏–ª –≤ URL-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ –∏ –Ω–µ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–ª—Å—è
  - –ù–µ —É—á–∏—Ç—ã–≤–∞–ª–∏—Å—å —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –ø—É—Ç–µ–π (–ø—Ä—è–º—ã–µ/–æ–±—Ä–∞—Ç–Ω—ã–µ —Å–ª–µ—à–∏ –¥–ª—è Windows/Unix)
  - –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (500 –≤–º–µ—Å—Ç–æ 404)

### 2. –û—à–∏–±–∫–∞ 500 –≤ `/api/normalization/start`
- **–°–∏–º–ø—Ç–æ–º—ã:** HTTP 500 –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
- **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø—É—Ç–µ–π –ø—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –ø—É—Ç–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## ‚úÖ –†–µ—à–µ–Ω–∏—è

### 1. –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Ç–µ–π –≤ `handleFindProjectByDatabase`

**–§–∞–π–ª:** `server/server.go`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ URL-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É—Ç–µ–π —Å –ø–æ–º–æ—â—å—é `url.QueryUnescape()`
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Ç–µ–π —Å –ø–æ–º–æ—â—å—é `filepath.Clean()` –∏ `filepath.ToSlash()`
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–≤–æ–∑–≤—Ä–∞—Ç 404 –≤–º–µ—Å—Ç–æ 500)

**–ö–æ–¥:**
```go
// –î–µ–∫–æ–¥–∏—Ä—É–µ–º URL-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É—Ç—å
filePath, err := url.QueryUnescape(filePathRaw)
if err != nil {
    log.Printf("Warning: Failed to decode file_path %s, using as-is: %v", filePathRaw, err)
    filePath = filePathRaw
}

// –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—É—Ç—å (–ø—Ä–∏–≤–æ–¥–∏–º –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É)
filePath = filepath.Clean(filePath)
filePath = filepath.ToSlash(filePath)
```

### 2. –£–ª—É—á—à–µ–Ω –ø–æ–∏—Å–∫ –≤ `FindClientAndProjectByDatabasePath`

**–§–∞–π–ª:** `database/service_db.go`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ü–æ–∏—Å–∫ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–∞–º —Ñ–æ—Ä–º–∞—Ç–∞ –ø—É—Ç–∏ –≤ –æ–¥–Ω–æ–º SQL-–∑–∞–ø—Ä–æ—Å–µ
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä—è–º—ã—Ö –∏ –æ–±—Ä–∞—Ç–Ω—ã—Ö —Å–ª–µ—à–µ–π
- –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `path/filepath`

**–ö–æ–¥:**
```go
// –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø—É—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞
normalizedPath := filepath.Clean(filePath)
normalizedPathSlash := filepath.ToSlash(normalizedPath)
normalizedPathBackslash := filepath.FromSlash(normalizedPath)

// –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Å —Ä–∞–∑–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –ø—É—Ç–∏
query := `
    SELECT cp.client_id, pd.client_project_id
    FROM project_databases pd
    JOIN client_projects cp ON pd.client_project_id = cp.id
    WHERE pd.file_path = ? OR pd.file_path = ? OR pd.file_path = ? OR pd.file_path = ?
    LIMIT 1
`

err = db.conn.QueryRow(query, filePath, normalizedPath, normalizedPathSlash, normalizedPathBackslash).Scan(&clientID, &projectID)
```

### 3. –°–æ–∑–¥–∞–Ω—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—É—Ç–µ–π

**–§–∞–π–ª:** `server/server.go`

**–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `normalizePathForComparison(path string) []string` - –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø—É—Ç—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
- `pathsMatch(path1, path2 string) bool` - —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç –ø—É—Ç–∏ —Å —É—á–µ—Ç–æ–º —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```go
// –í–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
if db.FilePath == req.DatabasePath { ... }

// –ò—Å–ø–æ–ª—å–∑—É–µ–º:
if pathsMatch(db.FilePath, req.DatabasePath) { ... }
```

### 4. –£–ª—É—á—à–µ–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—É—Ç–µ–π –≤ `handleStartClientNormalization`

**–§–∞–π–ª:** `server/server.go`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `pathsMatch()` –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –ø—É—Ç–µ–π
- –£–ø—Ä–æ—â–µ–Ω –∫–æ–¥ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚ùå –û—à–∏–±–∫–∞ 500 –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
- ‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ URL-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É—Ç–µ–π
- ‚ùå –ù–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–æ–≤ –ø—É—Ç–µ–π (Windows/Unix)

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ URL-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—É—Ç–µ–π
- ‚úÖ –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –ø—É—Ç–µ–π (Windows/Unix)
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ HTTP-—Å—Ç–∞—Ç—É—Å—ã (404 –≤–º–µ—Å—Ç–æ 500)
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å –∫–æ–¥–∞

## üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –ü–æ–∏—Å–∫ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ –ø—É—Ç–∏
```bash
# URL-–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—É—Ç—å
curl "http://localhost:9999/api/databases/find-project?file_path=%D0%92%D1%8B%D0%B3%D1%80%D1%83%D0%B7%D0%BA%D0%B0_%D0%9D%D0%BE%D0%BC%D0%B5%D0%BD%D0%BA%D0%BB%D0%B0%D1%82%D1%83%D1%80%D0%B0_ERPWE_Unknown_Unknown_2025_11_20_10_18_55.db"

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 200 OK —Å client_id –∏ project_id
```

### –¢–µ—Å—Ç 2: –ó–∞–ø—É—Å–∫ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
```bash
curl -X POST http://localhost:9999/api/normalization/start \
  -H "Content-Type: application/json" \
  -d '{
    "database_path": "–í—ã–≥—Ä—É–∑–∫–∞_–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞_ERPWE_Unknown_Unknown_2025_11_20_10_18_55.db",
    "all_active": false
  }'

# –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 200 OK —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "started"
```

## üìù –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

1. `server/server.go`
   - `handleFindProjectByDatabase()` - —É–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Ç–µ–π
   - `handleStartClientNormalization()` - —É–ª—É—á—à–µ–Ω–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—É—Ç–µ–π
   - –î–æ–±–∞–≤–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ `normalizePathForComparison()` –∏ `pathsMatch()`

2. `database/service_db.go`
   - `FindClientAndProjectByDatabasePath()` - —É–ª—É—á—à–µ–Ω –ø–æ–∏—Å–∫ —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏ –ø—É—Ç–µ–π
   - –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç `path/filepath`

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ï–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—É—Ç–µ–π:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—É—Ç–∏ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å —Ä–∞–∑–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏.

2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π:** –ü—Ä–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –ø—É—Ç–µ–π –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `pathsMatch()` –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.

3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º —Å –ø—É—Ç—è–º–∏.

## üìÖ –î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

20 –Ω–æ—è–±—Ä—è 2025

## üë§ –ê–≤—Ç–æ—Ä

AI Assistant

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ

