# Исправление фильтрации номенклатур - Итоговый отчет

## Проблема

В системе показывались только нормализованные номенклатуры (1 штука), хотя в базе данных было больше номенклатур. Причина: базы данных, содержащие таблицу `normalized_data`, полностью пропускались при обработке, и не читались исходные данные из таблиц `catalog_items` или `nomenclature_items`.

## Решение

Удалена проверка на наличие таблицы `normalized_data`, которая пропускала базы данных полностью. Теперь метод `getNomenclatureFromMainDB` сам проверяет наличие нужных таблиц и читает данные из них, независимо от наличия таблицы `normalized_data`.

## Изменения в коде

### 1. `server/handlers/clients.go`
- **Строки 2155-2157**: Удалена проверка на наличие таблицы `normalized_data`
- Теперь базы обрабатываются независимо от наличия этой таблицы

### 2. `server/client_legacy_handlers.go`
- **Два места**: Удалена аналогичная проверка в методах получения номенклатур
- Обеспечена консистентность поведения во всех обработчиках

## Результат

### До исправления:
- Показывались только нормализованные номенклатуры из `normalized_data.db` (1 штука)
- Базы с таблицей `normalized_data` полностью пропускались

### После исправления:
- Показываются **все** номенклатуры:
  - Нормализованные из `normalized_data.db`
  - Исходные из баз проектов (включая базы с таблицей `normalized_data`)

## Тестирование

### Создан тест: `TestGetClientNomenclature_ShowsAllNomenclatures`
- Проверяет получение данных из всех источников
- Подтверждает, что базы с `normalized_data` не пропускаются
- Расположен: `server/handlers/clients_nomenclature_test.go`

### Создана утилита: `check_nomenclature_count.go`
- Позволяет проверить количество номенклатур в базе данных
- Показывает разбивку по источникам (нормализованные vs исходные)
- Расположена: `tools/check_nomenclature_count.go`

## Использование утилиты

```bash
# Компиляция
go build -o tools/check_nomenclature_count.exe tools/check_nomenclature_count.go

# Запуск
.\tools\check_nomenclature_count.exe -db "путь\к\базе.db" -client 1 -details
```

## Проверка исправления

Для проверки, что исправление работает:

1. Запустите утилиту на базе данных, которая содержит и `normalized_data`, и исходные таблицы
2. Убедитесь, что утилита показывает номенклатуры из обоих источников
3. Проверьте в интерфейсе, что отображаются все номенклатуры, а не только нормализованные

## Важные замечания

- Метод `getNomenclatureFromMainDB` сам проверяет наличие нужных таблиц (`catalog_items` или `nomenclature_items`) и возвращает пустой результат, если их нет
- Нормализованные данные обрабатываются отдельно через `getNomenclatureFromNormalizedDB`
- Дублирования данных не происходит, так как источники разные

## Файлы изменены

1. `server/handlers/clients.go` - удалена проверка на `normalized_data`
2. `server/client_legacy_handlers.go` - удалена проверка в двух местах
3. `server/handlers/clients_nomenclature_test.go` - добавлен тест (новый файл)
4. `tools/check_nomenclature_count.go` - добавлена утилита (новый файл)
5. `tools/README_nomenclature_check.md` - документация по утилите (новый файл)
6. `tools/USAGE_nomenclature_check.md` - краткая инструкция (новый файл)

