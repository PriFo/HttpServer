# HTML-поиск DuckDuckGo - Реализация

## Обзор

Реализован HTML-поиск DuckDuckGo для получения реальных результатов поиска специфических документов, таких как ГОСТы. Метод автоматически используется, когда Instant Answer API не возвращает результатов.

## Архитектура

### Гибридный подход

Метод `Search()` использует двухуровневую стратегию:

1. **Уровень 1: Instant Answer API** (быстрый, ~100 мс)
   - Используется для популярных запросов
   - Возвращает структурированные данные
   - Не требует парсинга HTML

2. **Уровень 2: HTML-поиск** (медленнее, ~2 сек)
   - Используется автоматически, если Instant Answer не дал результатов
   - Парсит HTML-страницы результатов поиска
   - Извлекает ссылки, заголовки и сниппеты

## Реализация

### Файл: `websearch/html_search.go`

#### Основные методы:

1. **`SearchHTML(ctx, query)`** - выполняет HTML-поиск
   - Делает запрос к `https://html.duckduckgo.com/html/`
   - Парсит HTML-страницу результатов
   - Возвращает `SearchResult`

2. **`parseHTMLResults(body, query)`** - парсит HTML
   - Использует `golang.org/x/net/html` для парсинга
   - Извлекает результаты поиска
   - Вычисляет уверенность

3. **`extractResults(n, result)`** - извлекает результаты
   - Рекурсивно обходит HTML-дерево
   - Ищет элементы с классом "result"
   - Извлекает информацию о каждом результате

4. **`extractResultItem(n)`** - извлекает информацию о результате
   - Находит ссылку (`<a>`)
   - Извлекает заголовок
   - Находит сниппет (описание)

5. **`findLink(n)`** - находит ссылку
   - Обрабатывает редиректы DuckDuckGo
   - Извлекает реальный URL из параметра `uddg`
   - Декодирует URL

6. **`findSnippet(n)`** - находит сниппет
   - Ищет элементы с классом "snippet"
   - Извлекает текст описания

7. **`calculateConfidence(results, query)`** - вычисляет уверенность
   - Базовая уверенность зависит от количества результатов
   - Бонус за совпадения запроса в результатах

## Обработка редиректов DuckDuckGo

DuckDuckGo использует редиректы для защиты пользователей. URL в формате:
```
//duckduckgo.com/l/?uddg=https%3A%2F%2Fdocs.cntd.ru%2Fdocument%2F566068325&rut=...
```

Реализация извлекает реальный URL из параметра `uddg`:
```go
if uddg := parsed.Query().Get("uddg"); uddg != "" {
    if decoded, err := url.QueryUnescape(uddg); err == nil {
        href = decoded
    }
}
```

## Результаты тестирования

### Тест с ГОСТами:

**Запрос:** "ГОСТ 1.1-2020"

**Результаты:**
- ✅ Найдено результатов: **92**
- ✅ Уверенность: **0.80**
- ✅ Источник: `duckduckgo-html`
- ✅ Время выполнения: ~2 секунды

**Найденные источники:**
- `docs.cntd.ru` - Техэксперт (база ГОСТов)
- `files.stroyinf.ru` - PDF файлы ГОСТов
- `internet-law.ru` - База ГОСТов

## Преимущества

1. **Автоматический fallback** - прозрачно для пользователя
2. **Реальные результаты** - находит специфические документы
3. **Кэширование** - результаты кэшируются
4. **Rate limiting** - соблюдается лимит запросов

## Ограничения

1. **Время выполнения** - HTML-поиск медленнее (~2 сек vs ~100 мс)
2. **Парсинг HTML** - может сломаться при изменении структуры страницы
3. **Редиректы** - требуется дополнительная обработка URL

## Рекомендации

1. Использовать кэширование для часто запрашиваемых запросов
2. Мониторить изменения в структуре HTML DuckDuckGo
3. Рассмотреть альтернативные источники для критичных запросов

