# Мульти-провайдерная нормализация

## Обзор

Система мульти-провайдерной нормализации позволяет использовать все доступные AI провайдеры одновременно для повышения точности и надежности нормализации товаров.

## Архитектура

### Компоненты

1. **ProviderOrchestrator** (`server/provider_orchestrator.go`)
   - Управляет всеми активными провайдерами
   - Отправляет запросы параллельно ко всем провайдерам
   - Агрегирует результаты согласно выбранной стратегии

2. **ProviderClient Interface**
   - Унифицированный интерфейс для всех провайдеров
   - Методы: `GetCompletion()`, `GetProviderName()`, `IsEnabled()`

3. **Provider Adapters**
   - `ArliaiProviderAdapter` - адаптер для Arliai
   - `OpenRouterProviderAdapter` - адаптер для OpenRouter
   - `HuggingFaceProviderAdapter` - адаптер для Hugging Face

4. **MultiProviderAINormalizer** (`server/provider_normalizer.go`)
   - Обертка для использования оркестратора в нормализации
   - Совместим с интерфейсом `AINormalizer`

## Стратегии агрегации

### 1. first_success (По умолчанию)
**Описание**: Возвращает первый успешный ответ от любого провайдера.

**Преимущества**:
- Максимальная скорость
- Минимальная нагрузка на провайдеры

**Недостатки**:
- Качество зависит от самого быстрого провайдера
- Не использует преимущества консенсуса

**Использование**: Для быстрой нормализации, когда скорость важнее точности.

### 2. majority_vote
**Описание**: Дожидается ответов от всех провайдеров и выбирает результат, который вернуло большинство.

**Преимущества**:
- Высокая надежность
- Консенсус между провайдерами
- Защита от ошибок отдельных провайдеров

**Недостатки**:
- Медленнее (нужно ждать всех ответов)
- Требует минимум 2 активных провайдера

**Использование**: Для критически важных данных, где точность важнее скорости.

### 3. highest_confidence
**Описание**: Выбирает результат с наивысшей уверенностью (confidence score).

**Преимущества**:
- Использует метаданные о качестве ответа
- Автоматический выбор лучшего результата

**Недостатки**:
- Требует, чтобы провайдеры возвращали confidence score
- Может выбрать неправильный результат, если confidence неточный

**Использование**: Когда провайдеры возвращают надежные confidence scores.

### 4. all_results
**Описание**: Возвращает все результаты от всех провайдеров.

**Преимущества**:
- Максимальная гибкость
- Позволяет вышестоящей логике принять решение

**Недостатки**:
- Усложняет обработку
- Требует дополнительной логики на клиенте

**Использование**: Для анализа и сравнения результатов разных провайдеров.

## Конфигурация

### Переменные окружения

```bash
# Включить мульти-провайдерный режим
MULTI_PROVIDER_ENABLED=true

# Выбрать стратегию агрегации
AGGREGATION_STRATEGY=first_success  # или majority_vote, highest_confidence, all_results

# Таймаут для запросов к провайдерам
AI_TIMEOUT=30s
```

### API Endpoints

#### Получить текущую стратегию
```bash
GET /api/workers/orchestrator/strategy
```

Ответ:
```json
{
  "current_strategy": "first_success",
  "available_strategies": [
    "first_success",
    "majority_vote",
    "all_results",
    "highest_confidence"
  ],
  "active_providers": [
    {
      "id": "arliai",
      "name": "Arliai",
      "priority": 1,
      "enabled": true
    },
    {
      "id": "openrouter",
      "name": "OpenRouter",
      "priority": 2,
      "enabled": true
    }
  ],
  "total_providers": 2
}
```

#### Установить стратегию
```bash
POST /api/workers/orchestrator/strategy
Content-Type: application/json

{
  "strategy": "majority_vote"
}
```

Ответ:
```json
{
  "success": true,
  "previous_strategy": "first_success",
  "current_strategy": "majority_vote",
  "message": "Strategy changed from first_success to majority_vote"
}
```

## Использование

### Автоматическая регистрация провайдеров

При запуске сервера все активные провайдеры автоматически регистрируются в оркестраторе:

1. **Arliai** - если установлен `ARLIAI_API_KEY`
2. **OpenRouter** - если установлен `OPENROUTER_API_KEY`
3. **Hugging Face** - если установлен `HUGGINGFACE_API_KEY`

Приоритеты провайдеров берутся из конфигурации воркеров (`WorkerConfigManager`).

### Интеграция в нормализацию

Оркестратор автоматически используется в процессе нормализации, если:
- `MULTI_PROVIDER_ENABLED=true`
- Есть хотя бы один активный провайдер

### Мониторинг

Оркестратор интегрирован с `MonitoringManager` для отслеживания:
- Количества запросов к каждому провайдеру
- Успешных/неуспешных запросов
- Среднего времени ответа
- Статуса каждого провайдера

## Примеры использования

### Пример 1: Быстрая нормализация (first_success)

```bash
# Установить стратегию
curl -X POST http://localhost:9999/api/workers/orchestrator/strategy \
  -H "Content-Type: application/json" \
  -d '{"strategy": "first_success"}'

# Запустить нормализацию
# Система будет использовать первый успешный ответ
```

### Пример 2: Надежная нормализация (majority_vote)

```bash
# Установить стратегию
curl -X POST http://localhost:9999/api/workers/orchestrator/strategy \
  -H "Content-Type: application/json" \
  -d '{"strategy": "majority_vote"}'

# Запустить нормализацию
# Система будет ждать ответов от всех провайдеров и выбирать консенсус
```

### Пример 3: Анализ всех результатов

```bash
# Установить стратегию
curl -X POST http://localhost:9999/api/workers/orchestrator/strategy \
  -H "Content-Type: application/json" \
  -d '{"strategy": "all_results"}'

# Запустить нормализацию
# Получить все результаты для анализа
```

## Рекомендации

### Когда использовать first_success
- Большие объемы данных
- Скорость важнее точности
- Один провайдер надежнее других

### Когда использовать majority_vote
- Критически важные данные
- Точность важнее скорости
- Есть минимум 2-3 активных провайдера

### Когда использовать highest_confidence
- Провайдеры возвращают надежные confidence scores
- Нужен автоматический выбор лучшего результата

### Когда использовать all_results
- Анализ и сравнение провайдеров
- Разработка и тестирование
- Сложная логика выбора на клиенте

## Производительность

### Параллельное выполнение
Все запросы к провайдерам выполняются параллельно с использованием goroutines, что минимизирует общее время выполнения.

### Таймауты
Каждый запрос имеет таймаут (по умолчанию 30 секунд). Если провайдер не отвечает в течение таймаута, его результат не учитывается.

### Кэширование
Результаты нормализации кэшируются, поэтому повторные запросы для того же товара не требуют обращения к провайдерам.

## Отказоустойчивость

- Если один провайдер недоступен, используются остальные
- При стратегии `first_success` система продолжит работу даже если часть провайдеров недоступна
- При стратегии `majority_vote` требуется минимум 2 активных провайдера
- Все ошибки логируются для мониторинга

## Мониторинг и логирование

Оркестратор логирует:
- Какую стратегию использует
- Какие провайдеры задействованы
- Какой ответ от какого провайдера был получен и за какое время
- Какой итоговый результат был выбран и почему

Пример лога:
```
[MultiProvider] Normalized 'Болт М8х20' using strategy 'majority_vote': 2/3 providers succeeded, final confidence: 0.95
[Orchestrator] Majority vote: 2/3 providers agree on result from key 'инструмент|болт м8'
```

## Будущие улучшения

- [ ] Весовые коэффициенты для провайдеров
- [ ] Адаптивная стратегия (автоматический выбор на основе истории)
- [ ] Метрики качества по провайдерам
- [ ] Автоматическое переключение стратегий на основе нагрузки
- [ ] Поддержка кастомных стратегий через плагины

