# Улучшения бенчмарка моделей Arliai API

## Дата: 2025-01-21

## Проблема
Бенчмарк получал только 2 модели из Arliai API, хотя в API доступно больше моделей (все бесплатные с месячной подпиской).

## Реализованные улучшения

### 1. Улучшена функция получения моделей (`getAvailableModels()`)

#### Очистка кеша
- Кеш очищается перед получением моделей для бенчмарка, чтобы получить свежие данные

#### Множественные попытки с разными параметрами
Функция пробует получить модели с разными query-параметрами:
1. `status=all` - все статусы (active, deprecated, beta)
2. `include=all` - включить все модели
3. `all=true` - альтернативный параметр
4. Без параметров (fallback)

#### Альтернативный способ через внутренний API
Если прямой вызов Arliai API не работает, используется внутренний API сервера:
- `/api/workers/models?enabled=all&status=all`
- Использует порт из конфигурации сервера

#### Улучшенное логирование
- Логируется количество полученных моделей на каждом этапе
- Логируются первые модели с их статусами
- Логируется URL каждого запроса
- Предупреждение, если получено ≤ 2 моделей

### 2. Улучшен `GetModels()` в `arliai_client.go`

#### Поддержка query-параметров
- Добавлена поддержка опциональных query-параметров
- Можно передавать параметры для получения всех моделей

#### Расширенное логирование
- Логируется URL запроса
- Логируются первые модели с их статусами
- Логируется тело ответа при ошибках декодирования

### 3. Улучшена валидация и обработка ошибок

#### Валидация количества моделей
- Проверка, что получено хотя бы одна модель
- Предупреждение, если получено ≤ 2 моделей
- Информативные сообщения об ошибках

#### Улучшенная обработка ошибок
- Детальное логирование ошибок на каждом этапе
- Fallback-механизмы для получения моделей
- Информативные сообщения для пользователя

### 4. Добавлена статистика бенчмарка

#### Статистика в логах
- Количество успешных моделей
- Количество неудачных моделей
- Общее количество успешных запросов
- Общее количество ошибок

#### Статистика в ответе API
Ответ API теперь включает раздел `statistics`:
```json
{
  "statistics": {
    "successful_models": 5,
    "failed_models": 1,
    "total_successes": 75,
    "total_errors": 15,
    "total_requests": 90,
    "overall_success_rate": 83.33
  }
}
```

### 5. Обновлен тестовый файл `test_arliai_models_benchmark.go`

#### Множественные варианты запросов
Тестовый файл теперь пробует:
1. `enabled=all&status=all`
2. `enabled=all`
3. `status=all`
4. Без параметров

#### Улучшенное логирование
- Логируется каждая попытка получения моделей
- Показываются результаты каждой попытки
- Предупреждение, если получено мало моделей

#### Исключение дубликатов
- Используется `map[string]bool` для исключения дубликатов моделей

## Использование

### Запуск бенчмарка через API

```bash
POST /api/models/benchmark
Content-Type: application/json

{
  "auto_update_priorities": false,
  "test_products": ["Болт М8х20", "Гайка М8"],
  "max_retries": 5,
  "retry_delay_ms": 200,
  "models": []  // Пустой массив = все модели
}
```

### Запуск тестового скрипта

```bash
go run test_arliai_models_benchmark.go
```

## Проверка результатов

### Логи сервера
Проверьте логи сервера для детальной информации:
- Количество полученных моделей
- Какие параметры запроса сработали
- Статистика бенчмарка

### Ответ API
Ответ включает:
- Список всех протестированных моделей
- Статистику по успешности
- Приоритеты моделей (на основе скорости)

## Отладка

Если всё ещё получается только 2 модели:

1. Проверьте логи сервера - они покажут, что возвращает API
2. Проверьте переменную окружения `ARLIAI_API_KEY`
3. Проверьте, что API ключ имеет доступ ко всем моделям
4. Попробуйте запустить бенчмарк с параметром `models: []` для получения всех моделей

## Файлы изменены

1. `server/server_models_benchmark.go` - основная логика бенчмарка
2. `server/arliai_client.go` - клиент Arliai API
3. `test_arliai_models_benchmark.go` - тестовый скрипт

## Следующие шаги

- Мониторинг результатов бенчмарка
- Настройка автоматического обновления приоритетов
- Добавление метрик производительности
- Интеграция с системой мониторинга

