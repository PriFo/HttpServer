# Архитектура системы нормализации данных о контрагентах

## Обзор системы

Система нормализации данных о контрагентах представляет собой enterprise-решение для автоматической нормализации и обогащения информации о компаниях из различных источников. Система использует гибридный подход, комбинируя специализированные SaaS-провайдеры и генеративные AI-модели.

## Компоненты системы

### 1. API Layer (HTTP Server)

**Файл**: `server/server.go`

HTTP-сервер, обрабатывающий входящие запросы от клиентов (1С, веб-интерфейс). Основные эндпоинты:

- `/api/normalize/start` - запуск нормализации контрагентов
- `/api/normalize/stop` - остановка нормализации
- `/api/normalize/status` - статус нормализации
- `/api/counterparties/*` - работа с контрагентами
- `/api/monitoring/*` - метрики и мониторинг

### 2. Provider Orchestrator

**Файл**: `server/provider_orchestrator.go`

Центральный компонент для координации работы с несколькими AI-провайдерами:

- **Параллельные запросы**: Отправляет запросы ко всем активным провайдерам одновременно
- **Стратегии агрегации**: 
  - `FirstSuccess` - возвращает первый успешный результат
  - `MajorityVote` - выбирает результат, получивший большинство голосов
  - `AllResults` - возвращает все результаты
  - `HighestConfidence` - выбирает результат с наивысшей уверенностью
- **Таймауты**: Управляет таймаутами для каждого провайдера
- **Мониторинг**: Интегрирован с MonitoringManager для отслеживания метрик

### 3. Multi-Provider Client

**Файл**: `server/multi_provider_client.go`

Клиент для работы с несколькими AI-провайдерами параллельно:

- **Каналы**: Каждый провайдер может иметь несколько каналов для параллельных запросов
- **Majority Vote**: Агрегирует результаты от всех провайдеров методом голосования
- **Fallback**: Автоматически переключается на резервные провайдеры при ошибках
- **Реализует AINameNormalizer**: Интерфейс для нормализации имен контрагентов

### 4. Counterparty Provider Router

**Файл**: `server/counterparty_provider_router.go`

Умный маршрутизатор для выбора правильного провайдера на основе ИНН/БИН:

- **Российские компании (ИНН)**: Маршрутизация в DaData.ru
- **Казахстанские компании (БИН)**: Маршрутизация в Adata.kz
- **Fallback**: При недоступности специализированных провайдеров переходит на генеративные AI

### 5. Counterparty Normalizer

**Файл**: `normalization/counterparty_normalizer.go`

Основной нормализатор контрагентов:

- **ProcessNormalization**: Обрабатывает массив контрагентов
- **Использует AINameNormalizer**: Для нормализации имен через AI
- **Контекст**: Использует `context.Context` для управления отменой операций
- **События**: Отправляет события о прогрессе через eventChannel

### 6. AI Providers

#### 6.1 OpenRouter Provider

**Файл**: `server/openrouter_client.go`, `server/provider_orchestrator.go`

- **Модель по умолчанию**: `z.ai/glm-4.5` (приоритетная)
- **Fallback модели**: `meta-llama/llama-3.2-3b-instruct:free`
- **Конфигурация**: Поддержка WorkerConfigManager с fallback на переменные окружения

#### 6.2 DaData Provider

**Файл**: `server/dadata_client.go`

- **Специализация**: Российские компании (ИНН)
- **Circuit Breaker**: Защита от каскадных сбоев
- **Retry**: Автоматические повторы при ошибках

#### 6.3 Adata.kz Provider

**Файл**: `server/adata_client.go`

- **Специализация**: Казахстанские компании (БИН)
- **Circuit Breaker**: Защита от каскадных сбоев

#### 6.4 Другие провайдеры

- **HuggingFace**: Генеративный AI провайдер
- **Arliai**: Генеративный AI провайдер
- **EdenAI**: Генеративный AI провайдер

### 7. Database Layer

**Файлы**: `database/db.go`, `database/service_db.go`

- **SQLite**: Основная база данных для хранения данных
- **ServiceDB**: База данных для метаданных (клиенты, проекты, сессии)
- **Транзакции**: Поддержка транзакций с откатом при ошибках

### 8. Monitoring & Metrics

**Файлы**: `server/metrics.go`, `server/monitoring.go`

- **MetricsCollector**: Сбор метрик для провайдеров и операций
- **Prometheus-ready**: Структура метрик готова для интеграции с Prometheus
- **Метрики**:
  - `provider_requests_total{provider="..."}`
  - `provider_errors_total{provider="...", error_type="..."}`
  - `provider_duration_seconds{provider="..."}`
  - `normalization_requests_total`
  - `normalization_duration_seconds`

### 9. Circuit Breaker

**Файл**: `server/http_circuit_breaker.go`

Защита от каскадных сбоев для HTTP-клиентов:

- **Состояния**: Closed, Open, Half-Open
- **Пороги**: Настраиваемые пороги для открытия/закрытия
- **Интеграция**: Используется в DaDataClient и других HTTP-клиентах

### 10. Structured Logging

**Использование**: `log/slog` (Go 1.21+)

- **Request ID**: Уникальный идентификатор для трассировки запросов
- **Структурированные логи**: JSON-формат для легкого парсинга
- **Ключевые события**:
  - "Routing request to DaData for INN ..."
  - "DaData returned no result, falling back to generative AI"
  - "Successfully normalized using provider: z.ai/glm-4.5"
  - "Provider z.ai/glm-4.5 failed with error: ..."

## Поток данных при типичном запросе

### Нормализация контрагента

```
1. HTTP Request → /api/normalize/start
   ↓
2. Server Handler → CounterpartyService.CreateNormalizer()
   ↓
3. CounterpartyNormalizer.ProcessNormalization()
   ↓
4. MultiProviderClient.NormalizeCounterparty()
   ↓
5. CounterpartyProviderRouter.RouteByTaxID()
   ├─→ ИНН (10/12 цифр) → DaDataClient
   └─→ БИН (12 цифр) → AdataKzClient
   ↓
6. Если специализированный провайдер недоступен/вернул ошибку:
   ↓
7. MultiProviderClient.NormalizeName()
   ├─→ OpenRouter (z.ai/glm-4.5) - приоритетный
   ├─→ HuggingFace
   ├─→ Arliai
   └─→ EdenAI
   ↓
8. Агрегация результатов (Majority Vote)
   ↓
9. Возврат нормализованного имени
```

### Параллельная обработка

```
MultiProviderClient запускает горутины для каждого провайдера:
- Каждый провайдер может иметь несколько каналов (параллельных запросов)
- Результаты собираются через каналы
- Агрегация методом majority vote
```

## Механизм остановки

Система использует `context.Context` для управления отменой операций:

1. **Создание контекста**: `CounterpartyService` создает контекст с возможностью отмены
2. **Передача контекста**: Контекст передается в `CounterpartyNormalizer`
3. **Проверка отмены**: В цикле обработки проверяется `ctx.Done()`
4. **Отмена операции**: При отмене контекста операция прерывается, транзакции откатываются

## Маршрутизация к провайдерам

### Логика выбора провайдера

1. **Приоритет БИН**: Если указан БИН (12 цифр) → Adata.kz
2. **ИНН**: Если указан ИНН (10 или 12 цифр) → DaData
3. **Fallback**: Если специализированный провайдер недоступен → Генеративные AI

### Определение страны

- **Россия**: ИНН 10 или 12 цифр
- **Казахстан**: БИН 12 цифр
- **Неопределено**: Fallback на генеративные AI

## Интеграция с z.ai/glm-4.5

### Конфигурация

1. **WorkerConfigManager**: Приоритетная модель `z.ai/glm-4.5` с Priority=1
2. **Переменная окружения**: `OPENROUTER_MODEL=z.ai/glm-4.5` (fallback)
3. **Дефолт**: `z.ai/glm-4.5` (если не указано)

### Использование

```go
openrouterAdapter := NewOpenRouterProviderAdapter(openrouterClient, workerConfigManager)
// Модель автоматически выбирается из конфигурации
result, err := openrouterAdapter.GetCompletion(systemPrompt, userPrompt)
```

## Отказоустойчивость

### Circuit Breaker

- **Порог ошибок**: 5 ошибок открывают circuit breaker
- **Таймаут**: 30 секунд перед попыткой восстановления
- **Half-Open**: 2 успешных запроса закрывают circuit breaker

### Retry механизм

- **Максимум попыток**: 3
- **Экспоненциальный backoff**: Начальная задержка 100ms, множитель 2.0
- **Максимальная задержка**: 5 секунд

### Fallback цепочка

1. Специализированный провайдер (DaData/Adata)
2. z.ai/glm-4.5 (OpenRouter) - приоритетный генеративный AI
3. Резервные генеративные AI (HuggingFace, Arliai, EdenAI)

## Наблюдаемость (Observability)

### Логирование

- **Структурированные логи**: `log/slog` с request_id
- **Уровни**: Info, Warn, Error
- **Контекст**: provider, request_id, duration_ms

### Метрики

- **Счетчики**: Количество запросов, ошибок
- **Гистограммы**: Длительность запросов
- **Готовность к Prometheus**: Структура метрик совместима с Prometheus

## Тестирование

### Unit-тесты

- **Моки провайдеров**: Изоляция компонентов
- **Тесты маршрутизации**: Проверка выбора правильного провайдера
- **Тесты агрегации**: Проверка стратегий голосования

### Интеграционные тесты

- **httptest.NewServer**: Мокирование внешних API
- **Проверка контрактов**: Валидация формата запросов/ответов
- **Тесты z.ai/glm-4.5**: Проверка передачи модели в запросе

### Тесты отказоустойчивости

- **Таймауты**: Проверка обработки таймаутов
- **Ошибки API**: Проверка fallback механизмов
- **Circuit Breaker**: Проверка поведения при сбоях

### Тесты конкурентности

- **Race conditions**: `go test -race`
- **Concurrent calls**: 100+ горутин одновременно
- **Бенчмарки**: Измерение производительности

## Зависимости

### Внешние зависимости

- **DaData.ru**: API для нормализации российских компаний
- **Adata.kz**: API для нормализации казахстанских компаний
- **OpenRouter**: API для доступа к AI-моделям (z.ai/glm-4.5)
- **HuggingFace**: API для генеративных AI-моделей
- **Arliai**: API для генеративных AI-моделей
- **EdenAI**: API для генеративных AI-моделей

### Внутренние зависимости

- **SQLite**: База данных
- **Go 1.21+**: Для `log/slog`
- **context.Context**: Для управления отменой операций

## Масштабирование

### Горизонтальное масштабирование

- **Независимые экземпляры**: Каждый экземпляр сервера независим
- **База данных**: SQLite может быть заменена на PostgreSQL для масштабирования

### Вертикальное масштабирование

- **Каналы провайдеров**: Увеличение количества параллельных запросов
- **Connection pooling**: Оптимизация HTTP-клиентов
- **Кэширование**: Кэширование результатов нормализации

## Безопасность

- **API ключи**: Хранение в переменных окружения или конфигурации
- **Таймауты**: Защита от зависания запросов
- **Circuit Breaker**: Защита от перегрузки внешних API
- **Валидация входных данных**: Проверка ИНН/БИН перед запросами

## Будущие улучшения

1. **Prometheus интеграция**: Полная интеграция с Prometheus для метрик
2. **Distributed Tracing**: Добавление OpenTelemetry для трассировки
3. **Кэширование**: Redis для кэширования результатов нормализации
4. **Очереди**: RabbitMQ/Kafka для асинхронной обработки
5. **Мониторинг**: Grafana дашборды для визуализации метрик

