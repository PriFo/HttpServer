# Дополнительные фильтры для API получения всех контрагентов

## Статус: ✅ ЗАВЕРШЕНО

## Обзор

Добавлены дополнительные фильтры по качеству данных для endpoint `/api/counterparties/all`.

## Новые параметры

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `min_quality` | float | Нет | Минимальная оценка качества (0.0-1.0). Записи без оценки качества исключаются, если указан этот параметр. |
| `max_quality` | float | Нет | Максимальная оценка качества (0.0-1.0). |

## Валидация

- Оба параметра должны быть в диапазоне от 0.0 до 1.0
- `min_quality` должен быть меньше или равен `max_quality` (если оба указаны)
- Некорректные значения игнорируются

## Примеры использования

### Фильтр по минимальному качеству

```bash
# Получить только контрагентов с качеством >= 0.8
curl "http://localhost:9999/api/counterparties/all?client_id=1&min_quality=0.8"
```

**Результат:**
- Включаются только контрагенты с `quality_score >= 0.8`
- Контрагенты без оценки качества (`quality_score = null`) исключаются

### Фильтр по максимальному качеству

```bash
# Получить контрагентов с качеством <= 0.5
curl "http://localhost:9999/api/counterparties/all?client_id=1&max_quality=0.5"
```

**Результат:**
- Включаются контрагенты с `quality_score <= 0.5`
- Контрагенты без оценки качества включаются (если не указан `min_quality`)

### Диапазон качества

```bash
# Получить контрагентов с качеством от 0.5 до 0.9
curl "http://localhost:9999/api/counterparties/all?client_id=1&min_quality=0.5&max_quality=0.9"
```

**Результат:**
- Включаются только контрагенты с `0.5 <= quality_score <= 0.9`
- Контрагенты без оценки качества исключаются

### Комбинация с другими фильтрами

```bash
# Нормализованные контрагенты с качеством >= 0.8, отсортированные по качеству
curl "http://localhost:9999/api/counterparties/all?client_id=1&source=normalized&min_quality=0.8&sort_by=quality&order=desc"
```

```bash
# Поиск контрагентов с качеством >= 0.7 в конкретном проекте
curl "http://localhost:9999/api/counterparties/all?client_id=1&project_id=1&min_quality=0.7&search=ООО"
```

## Логика фильтрации

1. **Только `min_quality` указан:**
   - Включаются контрагенты с `quality_score >= min_quality`
   - Исключаются контрагенты без оценки качества

2. **Только `max_quality` указан:**
   - Включаются контрагенты с `quality_score <= max_quality`
   - Включаются контрагенты без оценки качества

3. **Оба параметра указаны:**
   - Включаются контрагенты с `min_quality <= quality_score <= max_quality`
   - Исключаются контрагенты без оценки качества

4. **Ни один параметр не указан:**
   - Все контрагенты включаются (без фильтрации по качеству)

## Порядок применения фильтров

Фильтры применяются в следующем порядке:

1. Получение данных из источников (базы данных и нормализованные записи)
2. Применение поиска (`search`)
3. Применение фильтра по источнику (`source`)
4. **Применение фильтров по качеству (`min_quality`, `max_quality`)** ← новый шаг
5. Сортировка (`sort_by`, `order`)
6. Пагинация (`offset`, `limit`)

## Использование в экспорте

Фильтры по качеству также работают в endpoint экспорта:

```bash
# Экспорт контрагентов с качеством >= 0.8 в CSV
curl "http://localhost:9999/api/counterparties/all/export?client_id=1&min_quality=0.8&format=csv" -o high_quality.csv
```

## Технические детали

### Изменения в коде

1. **`database/service_db.go`:**
   - Расширена сигнатура `GetAllCounterpartiesByClient` для поддержки `minQuality` и `maxQuality`
   - Добавлена логика фильтрации после сбора всех контрагентов, но до сортировки

2. **`server/server.go`:**
   - Добавлена валидация параметров `min_quality` и `max_quality` в `handleGetAllCounterparties`
   - Добавлена валидация в `handleExportAllCounterparties`
   - Обновлено логирование для включения параметров качества

### Производительность

- Фильтрация по качеству выполняется в памяти после сбора всех данных
- Не влияет на параллельную обработку баз данных
- Минимальные накладные расходы на производительность

## Проверка

✅ Код компилируется успешно  
✅ Линтер не выявил ошибок  
✅ Валидация параметров работает корректно  
✅ Фильтрация по качеству работает правильно  
✅ Поддержка в экспорте работает  
✅ Логирование включает параметры качества  

## Готово к использованию

Фильтры по качеству полностью реализованы и готовы к использованию в продакшене.

**Примеры использования:**
```bash
# Высококачественные контрагенты
curl "http://localhost:9999/api/counterparties/all?client_id=1&min_quality=0.9"

# Среднее качество
curl "http://localhost:9999/api/counterparties/all?client_id=1&min_quality=0.5&max_quality=0.8"

# С экспортом
curl "http://localhost:9999/api/counterparties/all/export?client_id=1&min_quality=0.8&format=csv" -o export.csv
```

