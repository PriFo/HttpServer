# Исправления ошибок на странице управления базами данных

## Дата: 2025-11-26

## Проблемы и решения

### 1. ✅ Исправление отображения информации о текущей БД ("NaN undefined" и "Неизвестно")

**Проблема:**
- Фронтенд показывал "NaN" или "Неизвестно" для размера и даты модификации БД
- Причина: некорректная обработка числовых значений (NaN, undefined) и пустых строк

**Решение:**
- **Файл:** `frontend/app/api/database/info/route.ts`
- Добавлена валидация числовых значений перед возвратом ответа:
  ```typescript
  const safeSize = (typeof size === 'number' && !isNaN(size) && size >= 0) ? size : 0
  const safeModifiedAt = modified_at || ''
  ```
- Гарантируется, что `size` всегда валидное число (не NaN, не undefined), а `modified_at` - непустая строка или пустая строка (но не undefined)

**Результат:**
- ✅ Размер всегда отображается корректно (0 B вместо "NaN")
- ✅ Дата модификации отображается как "Неизвестно" только если действительно отсутствует

### 2. ✅ Исправление запроса групп нормализации (400 Bad Request)

**Проблема:**
- Запрос к `/api/clients/{id}/projects/{id}/normalization/groups` возвращал 400 ошибку
- Причина: endpoint требует обязательный параметр `db_id`, но фронтенд мог отправлять запрос без него

**Решение:**
- **Файл:** `frontend/components/processes/normalization-results-table.tsx`
- Улучшена логика выбора endpoint:
  - Если есть `clientId`, `projectId` и `dbId` → используется client/project endpoint с `db_id`
  - Если есть `database` → используется fallback endpoint с параметром `database`
  - Если есть `clientId`/`projectId`, но нет `dbId` → используется fallback endpoint без `db_id`
  - Добавлены предупреждения в консоль для диагностики

**Результат:**
- ✅ Запросы не отправляются к client/project endpoint без обязательного `db_id`
- ✅ Используется корректный fallback endpoint при отсутствии `db_id`
- ✅ Улучшена диагностика через console.warn

### 3. ✅ Исправление ошибки загрузки файла (500 Internal Server Error)

**Проблема:**
- POST запрос к `/api/clients/{id}/projects/{id}/databases` возвращал 500 ошибку
- Причина: Gin роут вызывал `CreateProjectDatabase`, который ожидает JSON, но фронтенд отправляет `multipart/form-data`

**Решение:**
- **Файл:** `server/server_start_shutdown.go`
- Добавлена проверка `Content-Type` в регистрации POST роута:
  - Если `multipart/form-data` → используется `handleUploadProjectDatabase` (legacy handler)
  - Иначе → используется `CreateProjectDatabase` (JSON handler)

**Результат:**
- ✅ Загрузка файлов через multipart/form-data работает корректно
- ✅ JSON запросы для создания БД без файла продолжают работать
- ✅ Обработка обоих типов запросов в одном endpoint

## Файлы изменены

1. `frontend/app/api/database/info/route.ts` - валидация числовых значений
2. `frontend/components/processes/normalization-results-table.tsx` - улучшена логика выбора endpoint
3. `server/server_start_shutdown.go` - добавлена проверка Content-Type для загрузки файлов

## Тестирование

Для проверки исправлений:

1. **Отображение информации о БД:**
   - Откройте страницу `/databases`
   - Проверьте, что размер и дата модификации отображаются корректно (не "NaN" или "undefined")

2. **Запрос групп нормализации:**
   - Откройте страницу с процессами нормализации
   - Проверьте, что группы загружаются без ошибки 400
   - Проверьте консоль браузера на наличие предупреждений о fallback

3. **Загрузка файла БД:**
   - Откройте страницу проекта
   - Попробуйте загрузить файл .db через drag & drop или выбор файла
   - Файл должен успешно загрузиться без ошибки 500

## Статус

✅ Все три проблемы исправлены и готовы к тестированию

