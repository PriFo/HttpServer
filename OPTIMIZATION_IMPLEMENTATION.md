# Реализация оптимизаций AI классификатора

## Обзор

Реализованы оптимизации для уменьшения размера промптов и улучшения производительности AI классификатора категорий товаров.

## Реализованные оптимизации

### 1. Упрощение формата категорий
- **Было**: Полное дерево с иерархией (2 уровня, 50 узлов)
- **Стало**: Компактный список категорий (15 категорий, только названия через запятую)
- **Экономия**: ~90–95% размера

### 2. Кэширование списка категорий
- Добавлен кэш `categoryListCache` с мьютексом
- Список категорий генерируется один раз и переиспользуется
- **Экономия**: Исключены повторные вычисления

### 3. Упрощение промпта
- **Было**: ~2000+ токенов с подробными инструкциями
- **Стало**: ~50–100 токенов с минимальным форматом
- **Экономия**: ~95% размера промпта

### 4. Упрощение системного промпта
- **Было**: 7 строк инструкций
- **Стало**: 1 строка
- **Экономия**: ~85% размера

### 5. Обрезка длинных названий
- Названия категорий обрезаются до 50 символов
- **Экономия**: Предотвращает переполнение токенов

### 6. Компактный формат вывода
- Убраны ID категорий из вывода
- Убраны отступы и форматирование дерева
- Используется простой список через запятую

## Новые возможности

### Логирование и мониторинг
- Логирование размера промптов (байты и оценка токенов)
- Логирование размера системного промпта
- Метрики использования кэша (hits/misses)
- Метрики производительности (время выполнения, средняя задержка)
- Префикс логов: `[AIClassifier]`
- Управление логированием через конфигурацию

### Конфигурируемые параметры
- `MaxCategories` - максимальное количество категорий в списке (по умолчанию 15)
- `MaxCategoryNameLen` - максимальная длина названия категории (по умолчанию 50)
- `EnableLogging` - включить/выключить детальное логирование (по умолчанию true)

### Переменные окружения
- `AI_CLASSIFIER_MAX_CATEGORIES` - максимальное количество категорий
- `AI_CLASSIFIER_MAX_NAME_LEN` - максимальная длина названия категории
- `AI_CLASSIFIER_ENABLE_LOGGING` - включить логирование (true/false)

### API эндпоинты
- `GET /api/classification/optimization-stats` - информация об оптимизациях и конфигурации

### Новые функции
- `buildCompactCategoryList(maxCategories int)` - создание компактного списка категорий
- `estimateTokens(text string)` - оценка количества токенов
- `GetCacheStats()` - получение статистики кэша
- `GetPerformanceStats()` - получение статистики производительности
- `GetConfig()` - получение текущей конфигурации
- `SetConfig(config)` - установка новой конфигурации

## Ожидаемые результаты

- **Размер контекста**: уменьшен в 50–100 раз (с ~105000 до ~1000–2000 токенов)
- **Производительность**: кэширование ускоряет последующие запросы
- **Надежность**: ошибки 503 должны исчезнуть
- **Качество**: классификация остается точной с упрощенным форматом

## Тестирование

Добавлены unit-тесты:
- `TestAIClassifierBuildCompactCategoryList` - тест компактного формата
- `TestAIClassifierEstimateTokens` - тест оценки токенов
- `TestAIClassifierGetCacheStats` - тест статистики кэша
- `TestAIClassifierCacheBehavior` - тест поведения кэша
- `TestAIClassifierBuildCompactCategoryListEmpty` - тест граничных случаев
- `TestAIClassifierConfig` - тест конфигурации
- `TestAIClassifierPerformanceStats` - тест метрик производительности

Все тесты проходят успешно.

## Использование

### Мониторинг в логах
```
[AIClassifier] Prompt size: 1234 bytes, estimated tokens: ~411
[AIClassifier] System prompt size: 78 bytes, estimated tokens: ~26
[AIClassifier] Cache HIT: category list reused (hits: 5, misses: 1)
[AIClassifier] Cache MISS: category list generated (hits: 5, misses: 2)
```

### Получение статистики оптимизаций
```bash
curl http://localhost:9999/api/classification/optimization-stats
```

### Получение статистики кэша (в коде)
```go
hits, misses := aiClassifier.GetCacheStats()
hitRate := float64(hits) / float64(hits+misses) * 100.0
```

### Получение статистики производительности (в коде)
```go
totalRequests, avgLatency := aiClassifier.GetPerformanceStats()
fmt.Printf("Total requests: %d, Average latency: %v\n", totalRequests, avgLatency)
```

### Настройка конфигурации
```go
// Получить текущую конфигурацию
config := aiClassifier.GetConfig()

// Установить новую конфигурацию
newConfig := classification.AIClassifierConfig{
    MaxCategories:      10,
    MaxCategoryNameLen: 30,
    EnableLogging:      false,
}
aiClassifier.SetConfig(newConfig)
```

### Настройка через переменные окружения
```bash
export AI_CLASSIFIER_MAX_CATEGORIES=10
export AI_CLASSIFIER_MAX_NAME_LEN=30
export AI_CLASSIFIER_ENABLE_LOGGING=false
```

## Следующие шаги

1. Перезапустить backend для применения изменений
2. Протестировать переклассификацию — ошибки 503 должны исчезнуть
3. Мониторинг: проверять размер промптов в логах
4. При необходимости можно:
   - Уменьшить количество категорий до 10
   - Использовать только основные разделы КПВЭД (01–99) без детализации
   - Добавить динамическую фильтрацию категорий по ключевым словам из названия товара

## Файлы изменений

- `classification/ai_classifier.go` - основные оптимизации
- `classification/classifier_test.go` - unit-тесты
- `server/server_classification.go` - API эндпоинт для статистики
- `server/server.go` - регистрация эндпоинта

