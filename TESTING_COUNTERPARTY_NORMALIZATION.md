# Тестирование нормализации контрагентов на всех базах данных

## Созданные тесты

### 1. Интеграционный тест `TestCounterpartyNormalization_AllDatabases`

**Файл**: `normalization/counterparty_normalization_integration_test.go`

Этот тест автоматически:
- Находит все базы данных с контрагентами в проекте
- Для каждой базы создает тестовую среду
- Запускает нормализацию контрагентов
- Проверяет результаты нормализации
- Валидирует извлечение данных (ИНН, БИН, адреса, контакты, банковские реквизиты)

**Запуск**:
```bash
go test ./normalization -v -run "^TestCounterpartyNormalization_AllDatabases$" -timeout 5m -short=false
```

### 2. Тест извлечения данных `TestCounterpartyNormalization_Extractors`

**Файл**: `normalization/counterparty_normalization_integration_test.go`

Тестирует корректность извлечения данных из XML атрибутов:
- ИНН/БИН/КПП
- Адреса
- Контактные данные (телефон, email, контактное лицо)
- Банковские реквизиты (название банка, расчетный счет, корреспондентский счет, БИК)
- Организационно-правовая форма

**Запуск**:
```bash
go test ./normalization -v -run "^TestCounterpartyNormalization_Extractors$" -timeout 30s
```

## Скрипты для автоматического тестирования

### PowerShell (Windows) - Рекомендуется
```powershell
# Тестирование всех найденных баз
.\scripts\test_counterparty_normalization.ps1

# С подробным выводом
.\scripts\test_counterparty_normalization.ps1 -Verbose

# Тестирование конкретной базы
.\scripts\test_counterparty_normalization.ps1 -DatabasePath "data/uploads/test.db"
```

### Standalone тест (Go)
```bash
# Тестирование всех найденных баз
go run normalization/test_real_databases.go --all

# Тестирование конкретных баз
go run normalization/test_real_databases.go data/uploads/Выгрузка_Контрагенты_*.db
```

### Bash (Linux/Mac)
```bash
chmod +x scripts/test_all_databases.sh
./scripts/test_all_databases.sh
```

## Найденные базы данных

Тест автоматически ищет базы данных в следующих директориях:
- `.` (корень проекта)
- `data/`
- `data/uploads/`

Исключаются служебные базы:
- `service.db`
- `test.db`

## Что проверяется

1. **Корректность нормализации**:
   - Обработка всех контрагентов из базы
   - Сохранение нормализованных данных в ServiceDB
   - Корректность нормализованных имен

2. **Извлечение данных**:
   - ИНН/БИН из атрибутов
   - Адреса (юридический и почтовый)
   - Контактные данные
   - Банковские реквизиты
   - Организационно-правовая форма

3. **Качество данных**:
   - Проверка, что нормализованные имена не пустые
   - Проверка, что исходные имена сохранены
   - Подсчет обогащенных записей

## Результаты тестирования

Тест выводит для каждой базы данных:
- Количество найденных контрагентов
- Количество обработанных контрагентов
- Количество совпадений с эталонами
- Количество обогащенных записей
- Количество групп дублей
- Количество ошибок
- Количество записей с извлеченными данными

## Примечания

- Тест использует моковый AI нормализатор для изоляции от внешних зависимостей
- Для полного тестирования с реальным AI нужно настроить переменные окружения
- Тест пропускает базы без контрагентов
- В режиме `-short` тест пропускается
- Standalone тест (`test_real_databases.go`) можно запускать независимо от других тестов

## Известные проблемы

Некоторые старые тестовые файлы используют устаревшую сигнатуру `NewCounterpartyNormalizer`. 
Они требуют обновления, но не влияют на работу новых интеграционных тестов.

Для обхода проблем с компиляцией используйте:
- Standalone тест: `go run normalization/test_real_databases.go --all`
- PowerShell скрипт: `.\scripts\test_counterparty_normalization.ps1`

## Статистика тестирования

При запуске тестов выводится следующая информация для каждой базы:
- Количество найденных контрагентов
- Время обработки
- Количество обработанных записей
- Количество совпадений с эталонами
- Количество обогащенных записей
- Количество групп дублей
- Количество записей с извлеченными данными:
  - С ИНН/БИН
  - С адресом
  - С контактами
  - С банковскими данными

