# Руководство по использованию оптимизаций классификации КПВЭД

## Обзор

Система классификации КПВЭД была оптимизирована для максимальной производительности с учетом ограничений Arliai API (2 параллельных запроса).

## Основные улучшения

### 1. Система ключевых слов
Автоматическая классификация для товаров с известными ключевыми словами без обращения к AI API.

**Поддерживаемые категории:**
- Метизы: болт, винт, гайка, саморез → `25.94.11` (изделия с резьбой), шайба, заклепка → `25.94.12` (ненарезные)
- Инструменты: ключ → `25.73.30`, сверло, фреза, коронка → `25.73.40`
- Подшипники: подшипник → `28.15.10`
- Строительные материалы: панель → `23.61.11`, уголок → `24.10.73`, арматура → `24.10.61`, фасонные элементы → `25.11.23`
- Электротехника: автомат → `27.12.22`, кабель → `27.32.13`
- Сантехника: муфта, тройник → `24.20.40`
- Гидравлика: пневмоцилиндр → `28.12.11`, редуктор → `28.15.24`, фильтр → `28.29.12`, сальник → `28.29.23`
- Сэндвич-панели: isowall, isopan, сэндвич, sandwich, изопан → `24.33.30`
- Прочие: лоток → `25.99.29`

### 2. Двухуровневое кэширование
- **Полный кэш**: для точных совпадений (normalizedName + category)
- **Кэш корневых слов**: для товаров с одинаковым корневым словом

### 3. Автоматическое обучение
Система автоматически обучается на успешных классификациях с уверенностью > 0.8.

### 4. Ограничение воркеров
Жестко установлено ограничение до 2 воркеров для соблюдения лимита Arliai API.

## Использование API

### Запуск переклассификации

**Endpoint:** `POST /api/kpved/reclassify-hierarchical`

**Запрос:**
```json
{
  "limit": 0  // 0 = все группы, или конкретное число
}
```

**Ответ:**
```json
{
  "classified": 150,
  "failed": 5,
  "total": 155,
  "total_duration_ms": 45000,
  "total_duration": "45s",
  "processing_time": "2m30s",
  "workers_used": 2,
  "efficiency_gps": 1.0
}
```

### Тестовая классификация одного товара

**Endpoint:** `POST /api/kpved/classify-hierarchical`

**Запрос:**
```json
{
  "normalized_name": "болт м10",
  "category": "инструмент"
}
```

**Ответ:**
```json
{
  "final_code": "25.94.11",
  "final_name": "Изделия с резьбой нарезанной из металлов черных, не включенные в другие группировки",
  "final_confidence": 0.98,
  "steps": [
    {
      "level": "group",
      "level_name": "Keyword Match",
      "code": "25.94.11",
      "name": "Изделия с резьбой нарезанной из металлов черных, не включенные в другие группировки",
      "confidence": 0.98,
      "reasoning": "Автоматическая классификация по ключевому слову 'болт'",
      "duration_ms": 1
    }
  ],
  "total_duration_ms": 5,
  "cache_hits": 0,
  "ai_calls_count": 0
}
```

## Логирование

Система логирует следующие события:

- `[Keyword]` - классификация по ключевому слову
- `[BaseWordCache]` - попадание в кэш корневых слов
- `[Cache]` - попадание в полный кэш
- `[KPVED Worker N]` - работа воркеров
- `[KPVED] Rate limit detected` - обнаружение rate limit

## Мониторинг производительности

### Метрики эффективности

1. **Efficiency (groups/sec)**: количество обработанных групп в секунду
2. **Cache hits**: процент попаданий в кэш
3. **Keyword matches**: процент классификаций по ключевым словам
4. **AI calls**: количество вызовов AI API

### Ожидаемые показатели

- **С ключевыми словами**: ~100-200 групп/сек (без AI вызовов)
- **С AI классификацией**: ~2-4 группы/сек (2 воркера, ~300-500ms на группу)
- **Смешанная нагрузка**: зависит от процента попаданий в кэш

## Настройка

### Добавление новых ключевых слов

Ключевые слова добавляются автоматически при успешной классификации с уверенностью > 0.8. Также можно добавить вручную в `normalization/keyword_classifier.go` в функцию `initializeCommonPatterns()`.

### Изменение порогов уверенности

В `normalization/hierarchical_classifier.go`:
- `minConfidence`: минимальная уверенность для продолжения классификации (по умолчанию 0.7)
- Порог для baseWordCache: 0.9 (в коде)
- Порог для обучения: 0.8 (в коде)

## Обработка ошибок

### Rate Limit
При обнаружении rate limit система автоматически делает паузу 2 секунды перед следующей попыткой.

### Ошибки БД
Система использует retry логику с экспоненциальной задержкой (до 5 попыток).

## Примеры использования

### Пример 1: Классификация болта (ключевое слово)
```bash
curl -X POST http://localhost:8080/api/kpved/classify-hierarchical \
  -H "Content-Type: application/json" \
  -d '{"normalized_name": "болт м10", "category": "инструмент"}'
```

**Результат:** Мгновенная классификация без AI вызова (5ms)

### Пример 2: Переклассификация всех групп
```bash
curl -X POST http://localhost:8080/api/kpved/reclassify-hierarchical \
  -H "Content-Type: application/json" \
  -d '{"limit": 0}'
```

**Результат:** Обработка всех групп с использованием 2 воркеров

### Пример 3: Переклассификация первых 100 групп
```bash
curl -X POST http://localhost:8080/api/kpved/reclassify-hierarchical \
  -H "Content-Type: application/json" \
  -d '{"limit": 100}'
```

## Рекомендации

1. **Мониторинг кэша**: Отслеживайте процент попаданий в кэш ключевых слов
2. **Расширение паттернов**: Добавляйте новые паттерны на основе статистики
3. **Балансировка**: Система автоматически использует ключевые слова, когда возможно
4. **Производительность БД**: Новые индексы ускоряют запросы, но могут увеличить размер БД

## Устранение неполадок

### Проблема: Низкий процент попаданий в кэш
**Решение:** Проверьте, есть ли ключевые слова для ваших товаров. Добавьте новые паттерны.

### Проблема: Rate limit ошибки
**Решение:** Система автоматически обрабатывает rate limit. Убедитесь, что используется не более 2 воркеров.

### Проблема: Медленная классификация
**Решение:** 
- Проверьте наличие индексов в БД
- Убедитесь, что используется кэш
- Проверьте скорость работы AI API

## Технические детали

### Архитектура
1. Проверка полного кэша
2. Проверка кэша корневых слов
3. Классификация по ключевым словам
4. Иерархическая классификация через AI (если не найдено)

### Производительность
- Ключевые слова: ~1-5ms
- Кэш: ~1ms
- AI классификация: ~300-500ms на группу

### Ограничения
- Arliai API: максимум 2 параллельных запроса
- Кэш: хранится в памяти (теряется при перезапуске)
- Ключевые слова: требуют ручного добавления или обучения

