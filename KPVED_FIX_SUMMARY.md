# Исправления для проблемы с классификацией КПВЭД

## Проблема
Все группы завершились с ошибкой при запуске классификации КПВЭД.

## Выполненные исправления

### 1. Улучшена обработка ошибок
**Файл:** `server/server.go`
- Добавлено детальное логирование ошибок в воркерах
- Добавлены примеры ошибок в ответ API (`error_samples`)
- Улучшено сообщение об ошибках с примерами

### 2. Добавлена защита от nil
**Файл:** `normalization/hierarchical_classifier.go`
- Добавлены проверки на `nil` для `keywordClassifier`
- Защита от паники при отсутствии keywordClassifier

### 3. Улучшено отображение ошибок на фронтенде
**Файл:** `frontend/components/processes/normalization-process-tab.tsx`
- Добавлено поле `errorSamples` в тип результата
- Улучшено отображение примеров ошибок
- Добавлено форматирование сообщений об ошибках

### 4. Добавлено детальное логирование
- Логирование начала классификации для каждой задачи
- Логирование создания классификатора
- Детальные сообщения об ошибках с примерами

## Как диагностировать проблему

### Шаг 1: Проверьте логи сервера
Ищите сообщения с префиксом `[KPVED]`:
```
[KPVED] ERROR creating hierarchical classifier: ...
[KPVED Worker N] ERROR classifying '...': ...
[KPVED] ERROR: All N groups failed classification!
```

### Шаг 2: Проверьте API ключ
```bash
curl http://localhost:9999/api/workers/config
```
Убедитесь, что API ключ Arliai настроен.

### Шаг 3: Проверьте данные КПВЭД
```bash
curl http://localhost:9999/api/kpved/stats
```
Убедитесь, что таблица `kpved_classifier` не пуста.

### Шаг 4: Проверьте примеры ошибок
После запуска классификации проверьте поле `error_samples` в ответе API или на фронтенде.

## Типичные причины ошибок

1. **API ключ не настроен**
   - Ошибка: "AI API key not configured"
   - Решение: Настройте через `/api/workers/config/update`

2. **Таблица kpved_classifier пуста**
   - Ошибка: "kpved_classifier table is empty"
   - Решение: Загрузите через `/api/kpved/load-from-file`

3. **Проблемы с сетью/AI API**
   - Ошибка: "ai call failed"
   - Решение: Проверьте доступность Arliai API и rate limits

4. **Нет кандидатов в дереве**
   - Ошибка: "no candidates found"
   - Решение: Проверьте структуру данных в kpved_classifier

## Следующие шаги

1. Запустите классификацию снова
2. Проверьте логи сервера
3. Проверьте примеры ошибок в ответе API
4. Используйте диагностический скрипт из `DIAGNOSE_KPVED_ISSUES.md`

## Улучшения в коде

- ✅ Детальное логирование ошибок
- ✅ Примеры ошибок в ответе API
- ✅ Улучшенное отображение на фронтенде
- ✅ Защита от nil для keywordClassifier
- ✅ Более информативные сообщения об ошибках

